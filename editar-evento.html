<!DOCTYPE html>
<html>
<head>
 <script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="auth.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f1a2e"/>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    /* ============================================
       GLOBAL NAV ‚Äî FA PRODU√á√ïES Design System
       ============================================ */
    :root {
      --nav-navy-900: #0a1628;
      --nav-navy-800: #0f1a2e;
      --nav-navy-700: #142240;
      --nav-navy-600: #1e3a5f;
      --nav-gold-500: #d4a853;
      --nav-gold-400: #e0bc6a;
      --nav-font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --nav-height: 68px;
      --nav-radius-md: 12px;
      --nav-radius-sm: 8px;
      --nav-radius-full: 999px;
    }

    .global-header {
      background: var(--nav-navy-800);
      color: white;
      padding: 0 20px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      position: sticky;
      top: 0;
      z-index: 200;
      font-family: var(--nav-font);
    }

    .global-header-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .global-header-brand:hover { opacity: 0.85; }

    .global-header-back {
      width: 32px;
      height: 32px;
      border-radius: var(--nav-radius-sm);
      background: rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
    }

    .global-header-brand:hover .global-header-back {
      background: rgba(212,168,83,0.15);
    }

    .global-header-back i { color: var(--nav-gold-400); width: 18px; height: 18px; }

    .global-header-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .global-header-title i { width: 20px; height: 20px; color: var(--nav-gold-400); }

    .global-header-user {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px 4px 4px;
      background: rgba(255,255,255,0.06);
      border-radius: var(--nav-radius-full);
      border: 1px solid rgba(255,255,255,0.08);
      font-family: var(--nav-font);
    }

    .global-header-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--nav-navy-600), rgba(58,96,152,0.8));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: var(--nav-gold-400);
      text-transform: uppercase;
    }

    .global-header-name {
      color: rgba(255,255,255,0.7);
      font-size: 12px;
      font-weight: 600;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height);
      background: var(--nav-navy-800);
      border-top: 1px solid rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: space-around;
      z-index: 200;
      padding-bottom: env(safe-area-inset-bottom);
      font-family: var(--nav-font);
    }

    .bnav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      padding: 8px 14px;
      border-radius: var(--nav-radius-md);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      text-decoration: none;
      border: none;
      background: none;
      transition: all 0.2s;
    }

    .bnav-item i { width: 22px; height: 22px; color: rgba(255,255,255,0.55); transition: color 0.2s; }
    .bnav-item span { font-family: var(--nav-font); font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.55); transition: color 0.2s; }
    .bnav-item.active i, .bnav-item:hover i { color: var(--nav-gold-400); }
    .bnav-item.active span, .bnav-item:hover span { color: var(--nav-gold-400); }
    .bnav-item.active { background: rgba(212,168,83,0.08); }

    @media (min-width: 768px) {
      .bottom-nav { display: none; }
      body { padding-bottom: 0 !important; }
    }

    @media (max-width: 767px) {
      body { padding-bottom: calc(var(--nav-height) + 16px) !important; }
    }
  </style>

  <style>
    /* ============================================
       DESIGN SYSTEM ‚Äî FA PRODU√á√ïES (editar-evento)
       ============================================ */
    :root {
      --navy-900: #0a1628;
      --navy-800: #0f1a2e;
      --navy-700: #142240;
      --navy-600: #1e3a5f;
      --navy-500: #264a7a;
      --navy-400: #3a6098;
      --gold-600: #b8903e;
      --gold-500: #d4a853;
      --gold-400: #e0bc6a;
      --gold-300: #ebd08c;
      --gray-50: #f8f9fc;
      --gray-100: #f1f3f8;
      --gray-200: #e2e6ef;
      --gray-300: #cdd3e0;
      --gray-400: #9ca3b8;
      --gray-500: #6b7490;
      --gray-600: #4a5268;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #3b82f6;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 3px rgba(10,22,40,0.06);
      --shadow-md: 0 4px 16px rgba(10,22,40,0.08);
      --shadow-lg: 0 8px 32px rgba(10,22,40,0.14);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font);
      background: var(--gray-50);
      color: var(--gray-800);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ============================================
       CONTAINER & PAGE HEADER
       ============================================ */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 20px 32px;
    }

    @media (min-width: 768px) {
      .container { padding: 32px; }
    }

    .container > h2 {
      display: none;
    }

    .subtitle {
      display: none;
    }

    /* ============================================
       SEARCH SECTION
       ============================================ */
    .search-section {
      background: white;
      padding: 24px 20px;
      border-radius: var(--radius-md);
      margin-bottom: 16px;
      border: 1px solid var(--gray-200);
      border-left: 4px solid var(--navy-600);
      box-shadow: var(--shadow-sm);
    }

    .search-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--navy-600);
      margin-bottom: 20px;
      letter-spacing: -0.2px;
    }

    /* ============================================
       TOGGLE BUTTONS
       ============================================ */
    .toggle-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }

    .toggle-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: white;
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font);
      color: var(--gray-500);
    }

    .toggle-btn:hover {
      border-color: var(--navy-500);
      background: rgba(30,58,95,0.04);
      color: var(--navy-600);
    }

    .toggle-btn.active {
      background: var(--navy-600);
      border-color: var(--navy-600);
      color: white;
    }

    .toggle-btn input[type="radio"] {
      display: none;
    }

    .toggle-icon {
      font-size: 16px;
    }

    /* ============================================
       SEARCH FIELDS
       ============================================ */
    .search-fields {
      min-height: 80px;
    }

    .search-field-group {
      display: none;
    }

    .search-field-group.active {
      display: block;
      animation: fadeIn 0.25s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .search-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .search-input-wrapper input,
    .search-input-wrapper select {
      flex: 1;
      padding: 11px 14px;
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-family: var(--font);
      color: var(--gray-800);
      background: white;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input-wrapper input:focus,
    .search-input-wrapper select:focus {
      outline: none;
      border-color: var(--navy-500);
      box-shadow: 0 0 0 3px rgba(30,58,95,0.08);
    }

    .btn-search {
      padding: 11px 20px;
      background: var(--navy-600);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .btn-search:hover {
      background: var(--navy-500);
    }

    .helper-text {
      font-size: 12px;
      color: var(--gray-400);
      margin-top: 8px;
      font-weight: 500;
    }

    /* ============================================
       AUTOCOMPLETE
       ============================================ */
    .autocomplete-wrapper {
      position: relative;
      flex: 1;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--gray-200);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 6px 16px rgba(10,22,40,0.1);
    }

    .autocomplete-list.show {
      display: block;
    }

    .autocomplete-item {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 14px;
      color: var(--gray-700);
      border-bottom: 1px solid var(--gray-100);
      transition: background 0.15s;
    }

    .autocomplete-item:hover {
      background: var(--gray-50);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    /* ============================================
       SEARCH RESULTS
       ============================================ */
    .results-section {
      margin-top: 20px;
      display: none;
    }

    .results-section.show {
      display: block;
      animation: fadeIn 0.25s ease;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .results-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--navy-600);
      letter-spacing: -0.2px;
    }

    .results-count {
      font-size: 13px;
      color: var(--gray-400);
      font-weight: 500;
    }

    .results-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .result-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }

    .result-card:hover {
      border-color: var(--navy-400);
      box-shadow: 0 4px 12px rgba(30,58,95,0.1);
    }

    .result-id {
      font-size: 11px;
      color: var(--gray-400);
      font-family: 'SF Mono', 'Fira Code', monospace;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .result-main {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 8px;
      letter-spacing: -0.2px;
    }

    .result-details {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .result-detail {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .result-actions {
      display: flex;
      gap: 8px;
    }

    .btn-card {
      padding: 7px 14px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-edit {
      background: var(--navy-600);
      color: white;
    }

    .btn-edit:hover {
      background: var(--navy-500);
    }

    .btn-view {
      background: var(--gray-100);
      color: var(--gray-600);
      border: 1px solid var(--gray-200);
    }

    .btn-view:hover {
      background: var(--gray-200);
    }

    /* ============================================
       FORM ELEMENTS
       ============================================ */
    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      color: var(--gray-700);
      font-weight: 600;
      font-size: 13px;
      letter-spacing: -0.1px;
    }

    .label-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .indicator {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: 0.1px;
    }

    .indicator-free {
      background: rgba(16,185,129,0.1);
      color: #065f46;
    }

    .indicator-warning {
      background: rgba(245,158,11,0.1);
      color: #92400e;
    }

    .indicator-critical {
      background: rgba(239,68,68,0.08);
      color: #991b1b;
    }

    input, select, textarea {
      width: 100%;
      padding: 11px 14px;
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-family: var(--font);
      color: var(--gray-800);
      background: white;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--navy-500);
      box-shadow: 0 0 0 3px rgba(30,58,95,0.08);
    }

    input::placeholder, textarea::placeholder {
      color: var(--gray-400);
    }

    input:disabled, select:disabled {
      background: var(--gray-100);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .campo-bloqueado {
      background-color: var(--gray-100) !important;
      color: var(--gray-400) !important;
      cursor: not-allowed;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
        gap: 0;
      }
    }

    /* ============================================
       EDIT FORM SECTIONS
       ============================================ */
    .section {
      margin-bottom: 12px;
      padding: 24px 20px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--navy-600);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gray-200);
      letter-spacing: -0.2px;
    }

    /* ============================================
       STATUS BOXES
       ============================================ */
    .status-box {
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      line-height: 1.5;
    }

    .status-box.safe {
      background: rgba(16,185,129,0.08);
      border: 1px solid rgba(16,185,129,0.2);
      color: #065f46;
    }

    .status-box.warning {
      background: rgba(245,158,11,0.08);
      border: 1px solid rgba(245,158,11,0.2);
      color: #92400e;
    }

    .status-box.danger {
      background: rgba(239,68,68,0.06);
      border: 1px solid rgba(239,68,68,0.15);
      color: #991b1b;
    }

    .status-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    /* ============================================
       BUTTONS
       ============================================ */
    .btn {
      padding: 11px 22px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: -0.1px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--navy-600), var(--navy-700));
      color: white;
      box-shadow: 0 2px 8px rgba(30,58,95,0.2);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(30,58,95,0.25);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      background: var(--gray-300);
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-600);
      border: 1px solid var(--gray-200);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .actions {
      margin-top: 24px;
      text-align: center;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* ============================================
       ALERTS
       ============================================ */
    .alert {
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 500;
      line-height: 1.5;
    }

    .alert-success {
      background: rgba(16,185,129,0.08);
      color: #065f46;
      border: 1px solid rgba(16,185,129,0.2);
    }

    .alert-error {
      background: rgba(239,68,68,0.06);
      color: #991b1b;
      border: 1px solid rgba(239,68,68,0.15);
    }

    .alert-info {
      background: rgba(59,130,246,0.06);
      color: #1e40af;
      border: 1px solid rgba(59,130,246,0.15);
    }

    .hidden {
      display: none !important;
    }

    /* ============================================
       LOADING STATE (BOT√ïES E INTERA√á√ïES)
       ============================================ */
    [aria-busy="true"] {
      cursor: wait !important;
      opacity: 0.7;
      pointer-events: none;
    }

    /* ============================================
       SKELETON LOADER ‚Äî FORM EDI√á√ÉO
       ============================================ */
    .skeleton input,
    .skeleton select,
    .skeleton textarea {
      background: linear-gradient(
        90deg,
        #f0f0f0 25%,
        #e6e6e6 37%,
        #f0f0f0 63%
      );
      background-size: 400% 100%;
      animation: shimmer 1.2s infinite;
      color: transparent !important;
      pointer-events: none;
    }

    .skeleton label,
    .skeleton .indicator,
    .skeleton .helper-text {
      color: transparent !important;
    }

    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    /* ============================================
       SKELETON LOADER ‚Äî LISTA DE RESULTADOS
       ============================================ */
    .skeleton-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-sm);
    }

    .skeleton-line {
      height: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      background: linear-gradient(
        90deg,
        #f0f0f0 25%,
        #e6e6e6 37%,
        #f0f0f0 63%
      );
      background-size: 400% 100%;
      animation: shimmer 1.2s infinite;
    }

    .skeleton-line.short { width: 40%; }
    .skeleton-line.medium { width: 65%; }
    .skeleton-line.long { width: 85%; }

    /* ============================================
   SUCCESS CARD ‚Äî CENTRALIZADO
   ============================================ */
.success-overlay {
  position: fixed;
  inset: 0;
  z-index: 1500;

  display: flex;
  align-items: center;
  justify-content: center;

  background: rgba(10,22,40,0.55);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

.success-card {
  background: #ffffff;
  border-radius: 16px;
  padding: 28px 24px;
  max-width: 420px;
  width: 90%;
  box-shadow: 0 12px 40px rgba(10,22,40,0.25);
  border: 1px solid rgba(16,185,129,0.25);
  text-align: center;
}

    /* ============================================
       MODAL
       ============================================ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10,22,40,0.55);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      padding: 28px 24px;
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 92%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-title {
      font-size: 17px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.2px;
    }

    /* ============================================
       CHANGES LIST (modal)
       ============================================ */
    .changes-list {
      list-style: none;
      margin: 16px 0;
    }

    .change-item {
      padding: 14px;
      margin-bottom: 8px;
      background: var(--gray-50);
      border-left: 3px solid var(--navy-500);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }

    .change-field {
      font-weight: 700;
      color: var(--navy-600);
      margin-bottom: 4px;
      font-size: 13px;
      letter-spacing: -0.1px;
    }

    .change-values {
      font-size: 13px;
      color: var(--gray-500);
    }

    .change-old {
      color: var(--danger-color);
      text-decoration: line-through;
    }

    .change-new {
      color: var(--success-color);
      font-weight: 700;
    }

    .change-impact {
      margin-top: 8px;
      padding: 8px 10px;
      background: rgba(245,158,11,0.08);
      border-radius: 6px;
      font-size: 12px;
      color: #92400e;
      font-weight: 500;
    }

    .validation-summary {
      margin: 16px 0;
      padding: 14px 16px;
      background: rgba(30,58,95,0.04);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--navy-500);
    }

    .validation-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--gray-700);
      font-weight: 500;
    }

    .validation-item:last-child {
      margin-bottom: 0;
    }

    /* ============================================
       LOADING + SPINNER
       ============================================ */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-500);
    }

    .loading p {
      color: var(--gray-500);
      font-size: 14px;
      font-weight: 500;
    }

    .spinner {
      border: 3px solid var(--gray-200);
      border-top: 3px solid var(--gold-500);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ============================================
       EMPTY STATE
       ============================================ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-400);
    }

    .empty-icon {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.6;
    }

    /* ============================================
   TOGGLE SWITCH ‚Äî Evento multi-dias
   ============================================ */
.switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 26px;
  flex-shrink: 0;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background-color: #cbd5e1;
  transition: 0.3s;
  border-radius: 999px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.switch input:checked + .slider {
  background-color: var(--navy-600);
}

.switch input:checked + .slider:before {
  transform: translateX(20px);
}
.form-toggle {
  margin-top: 6px;
  margin-bottom: 18px;
}

.toggle-row {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 16px;
}

.toggle-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
}

/* Mobile: mant√©m compacto */
@media (max-width: 600px) {
  .toggle-row {
    padding-top: 4px;
  }
}
  </style>
</head>
<body>
  <!-- Global Header -->
  <div class="global-header">
    <a class="global-header-brand" onclick="window.location.href='index.html'" title="Voltar ao In√≠cio">
      <div class="global-header-back">
        <i data-lucide="arrow-left"></i>
      </div>
      <div class="global-header-title">
        <i data-lucide="pencil-line"></i>
        <span>Editar Evento</span>
      </div>
    </a>
    <div class="global-header-user">
      <div class="global-header-avatar" id="ghAvatar">--</div>
      <div class="global-header-name" id="ghName"></div>
    </div>
  </div>

  <div class="container">
    <h2>‚úèÔ∏è Editar Evento</h2>
    <p class="subtitle">Busque e edite eventos com valida√ß√µes autom√°ticas de seguran√ßa</p>
    
    <div id="globalLoading" class="modal-overlay">
      <div class="modal">
        <div class="loading">
          <div class="spinner"></div>
          <p id="globalLoadingText">Processando...</p>
        </div>
      </div>
    </div>
    <div id="alertContainer"></div>
    <div id="successCard" class="hidden success-overlay">
  <div class="success-card">
    <h3 style="margin-bottom:4px;">‚úÖ Evento atualizado com sucesso</strong>

    <p style="margin:12px 0;color:#555;font-size:14px;">
      As altera√ß√µes foram salvas corretamente.
    </p>

    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
      <button class="btn btn-secondary" onclick="window.location.reload()">‚úèÔ∏è Editar outro</button>
      <button class="btn btn-secondary" onclick="window.location.href='agenda.html'">üìÖ Ver agenda</button>
      <button class="btn btn-primary" onclick="window.location.href='index.html'">üè† Menu</button>
    </div>
  </div>
</div>
    
    <!-- SE√á√ÉO DE BUSCA -->
    <div class="search-section">
      <div class="search-title">üîç Como voc√™ quer buscar o evento?</div>
      
      <!-- BOT√ïES TOGGLE -->
      <div class="toggle-buttons">
        <label class="toggle-btn active">
          <input type="radio" name="searchType" value="id" checked onchange="trocarTipoBusca('id')">
          <span class="toggle-icon">üî¢</span>
          <span>Por ID</span>
        </label>
        
        <label class="toggle-btn">
          <input type="radio" name="searchType" value="nome" onchange="trocarTipoBusca('nome')">
          <span class="toggle-icon">üë§</span>
          <span>Por Nome</span>
        </label>
        
        <label class="toggle-btn">
          <input type="radio" name="searchType" value="data" onchange="trocarTipoBusca('data')">
          <span class="toggle-icon">üìÖ</span>
          <span>Por Data</span>
        </label>
        
        <label class="toggle-btn">
          <input type="radio" name="searchType" value="periodo" onchange="trocarTipoBusca('periodo')">
          <span class="toggle-icon">üóìÔ∏è</span>
          <span>Por Per√≠odo</span>
        </label>
      </div>
      
      <!-- CAMPOS DIN√ÇMICOS -->
      <div class="search-fields">
        
        <!-- BUSCA POR ID -->
        <div id="searchById" class="search-field-group active">
          <div class="search-input-wrapper">
            <input type="text" id="inputID" placeholder="Ex: AG-20251228-001" 
                   onkeypress="if(event.key==='Enter') buscarEvento()">
            <button class="btn-search" onclick="buscarEvento()">üîç Buscar</button>
          </div>
          <p class="helper-text">üí° Digite o ID completo ou parcial (ex: AG-2025)</p>
        </div>
        
        <!-- BUSCA POR NOME -->
        <div id="searchByNome" class="search-field-group">
          <div class="search-input-wrapper">
            <div class="autocomplete-wrapper">
              <input type="text" id="inputNome" placeholder="Digite o nome do contratante..." 
                     oninput="autocompleteContratante(this.value)"
                     onkeypress="if(event.key==='Enter') buscarEvento()">
              <div id="autocompleteList" class="autocomplete-list"></div>
            </div>
            <button class="btn-search" onclick="buscarEvento()">üîç Buscar</button>
          </div>
          <p class="helper-text">üí° Digite parte do nome e selecione da lista</p>
        </div>
        
        <!-- BUSCA POR DATA -->
        <div id="searchByData" class="search-field-group">
          <div class="search-input-wrapper">
            <input type="date" id="inputData" onchange="buscarEvento()">
            <button class="btn-search" onclick="buscarEvento()">üîç Buscar</button>
          </div>
          <p class="helper-text">üí° Selecione a data do evento</p>
        </div>
        
        <!-- BUSCA POR PER√çODO -->
        <div id="searchByPeriodo" class="search-field-group">
          <div class="search-input-wrapper">
            <select id="inputPeriodo" onchange="buscarEvento()">
              <option value="">-- Selecione um per√≠odo --</option>
              <option value="ultimos-7">√öltimos 7 dias</option>
              <option value="ultimos-30">√öltimos 30 dias</option>
              <option value="este-mes">Este m√™s</option>
              <option value="mes-passado">M√™s passado</option>
              <option value="proximos">Pr√≥ximos eventos</option>
              <option value="este-ano">Este ano</option>
            </select>
            <button class="btn-search" onclick="buscarEvento()">üîç Buscar</button>
          </div>
          <p class="helper-text">üí° Filtre eventos por per√≠odo de tempo</p>
        </div>
        
      </div>
      
      <!-- RESULTADOS DA BUSCA -->
      <div id="resultsSection" class="results-section">
        <div class="results-header">
          <div class="results-title">üìä Resultados da Busca</div>
          <div class="results-count" id="resultsCount"></div>
        </div>
        <div id="resultsList" class="results-list"></div>
      </div>
    </div>
    
    <!-- FORMUL√ÅRIO DE EDI√á√ÉO (inicialmente oculto) -->
    <div id="formEdicao" class="hidden">
      
      
      <!-- DADOS DO EVENTO -->
      <div class="section">
        <div class="section-title">üìÖ Dados do Evento</div>
        
        <!-- STATUS / CONFLITOS DE AGENDA -->
        <div id="statusAgenda"></div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Data do Evento</span>
              <span class="indicator indicator-warning">‚ö†Ô∏è Verifica conflitos</span>
            </label>
            <input type="date" id="dataEvento">
            <p class="helper-text">Altera√ß√£o verifica conflitos na agenda</p>
          </div>
        </div>
        <div class="form-group form-toggle">
  <div class="toggle-row">
    <label for="eventoMultiDias" class="toggle-label">
      Evento com mais de um dia
    </label>

    <label class="switch">
      <input type="checkbox" id="eventoMultiDias" onchange="toggleDataFimEdicao()">
      <span class="slider"></span>
    </label>
  </div>
</div>

        <div class="form-group hidden" id="grupoDataFim">
          <label class="label-indicator">
            <span>Data Fim</span>
            <span class="indicator indicator-warning">‚ö†Ô∏è Verifica conflitos</span>
          </label>
          <input type="date" id="dataFim">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Hora de In√≠cio</span>
              <span class="indicator indicator-warning">‚ö†Ô∏è Verifica conflitos</span>
            </label>
            <input type="time" id="horaInicio">
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Dura√ß√£o</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="duracao">
              <option value="">Selecione...</option>
            </select>
            <div id="horarioFimCalc" style="margin-top:8px;padding:8px;background:#e3f2fd;border-radius:4px;color:#0d47a1;font-weight:600;display:none;"></div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Tipo de Evento</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="tipoEvento">
  <option value="">Selecione...</option>
</select>
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Formato/Projeto</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="projeto">
              <option value="">Selecione...</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Contratante</span>
              <span class="indicator indicator-warning">‚ö†Ô∏è Atualiza refer√™ncia</span>
            </label>

            <div style="display:flex;gap:8px;align-items:center;">
              <div class="autocomplete-wrapper" style="flex:1;">
                <input type="text" id="contratanteNome" placeholder="Digite o nome do contratante...">
                <input type="hidden" id="idContratante">
                <div id="autocompleteContratanteList" class="autocomplete-list"></div>
              </div>

              <button type="button"
                class="btn btn-secondary"
                onclick="abrirCadastroRapidoContratante()"
                title="Cadastrar novo contratante">
                ‚ûï
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Cerimonialista</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <div class="autocomplete-wrapper">
              <input type="text" id="cerimonialistaNome" placeholder="Digite o nome do cerimonialista...">
              <input type="hidden" id="idCerimonialista">
              <div id="autocompleteCerimonialistaList" class="autocomplete-list"></div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="label-indicator">
            <span>Local do Evento</span>
            <span class="indicator indicator-warning">‚ö†Ô∏è Atualiza refer√™ncia</span>
          </label>

          <div style="display:flex;gap:8px;align-items:center;">
            <div class="autocomplete-wrapper" style="flex:1;">
              <input type="text" id="enderecoNome" placeholder="Digite o local do evento...">
              <input type="hidden" id="idEndereco">
              <div id="autocompleteEnderecoList" class="autocomplete-list"></div>
            </div>

            <button type="button"
              class="btn btn-secondary"
              onclick="abrirCadastroRapidoEndereco()"
              title="Cadastrar novo endere√ßo">
              ‚ûï
            </button>
          </div>
        </div>
      </div>
      
      <!-- DADOS FINANCEIROS -->
      <div class="section">
        <div class="section-title">üí∞ Dados Financeiros</div>
        <!-- STATUS / BLOQUEIO FINANCEIRO -->
        <div id="statusFinanceiro"></div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Valor Total (R$)</span>
              <span class="indicator indicator-critical">üî¥ Cr√≠tico</span>
            </label>
            <input type="number" id="valorTotal" step="0.01" min="0">
            <p class="helper-text">‚ö†Ô∏è Recalcula comiss√µes se houver pendentes</p>
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Vendedor</span>
              <span class="indicator indicator-critical">üî¥ Cr√≠tico</span>
            </label>
            <select id="idVendedor"></select>
            <p class="helper-text">‚ö†Ô∏è Pode transferir comiss√µes pendentes</p>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Valor BV (R$)</span>
              <span class="indicator indicator-critical">üî¥ Cr√≠tico</span>
            </label>
            <input type="number" id="valorBV" step="0.01" min="0">
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Parceiro BV</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="idBV">
              <option value="">-- Sem BV --</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Tem NF?</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="temNF">
              <option value="N√ÉO">N√£o</option>
              <option value="SIM">Sim</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- DETALHES OPERACIONAIS -->
      <div class="section">
        <div class="section-title">üé≠ Detalhes Operacionais</div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Look/Figurino</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <input type="text" id="look" placeholder="Ex: Terno">
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Respons√°vel Som</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <input type="text" id="somResponsavel" placeholder="Nome do m√∫sico">
          </div>
        </div>
        
        <div class="form-group">
          <label class="label-indicator">
            <span>Observa√ß√µes</span>
            <span class="indicator indicator-free">üü¢ Livre</span>
          </label>
          <textarea id="observacoes" placeholder="Anota√ß√µes gerais sobre o evento..."></textarea>
        </div>
      </div>
      
      <!-- A√á√ïES -->
      <div class="actions">
        <button class="btn btn-secondary" onclick="voltarParaBusca()">‚Ü©Ô∏è Voltar para Busca</button>
        <button class="btn btn-primary" onclick="validarEMostrarResumo()">
          üíæ Salvar Altera√ß√µes
        </button>
      </div>
    </div>
  </div>
  
  <!-- MODAL DE CONFIRMA√á√ÉO -->
  <div id="modalConfirmacao" class="modal-overlay">
    <div class="modal">
      <div class="modal-title">
        ‚ö†Ô∏è Confirmar Altera√ß√µes
      </div>
      
      <p style="margin-bottom: 20px; color: #666;">
        As seguintes altera√ß√µes ser√£o realizadas no evento:
      </p>
      
      <ul id="listaAlteracoes" class="changes-list"></ul>
      
      <div id="resumoValidacoes" class="validation-summary"></div>
      
      <div class="actions">
        <button class="btn btn-secondary" onclick="fecharModal()">‚Ü©Ô∏è Voltar</button>
        <button class="btn btn-primary" onclick="confirmarEdicao()">‚úÖ Confirmar Altera√ß√µes</button>
      </div>
    </div>
  </div>
  
  <script>
console.log('üöÄ editar-evento.html iniciado (frontend externo)');

// ============================
// CONTEXTO GLOBAL
// ============================
let EVENTO_ID_URL = null;

function getIdEventoFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}


  // ============================
  // CACHE GLOBAL
  // ============================
  window.__CACHE = {
    contratantes: null,
    cerimonialistas: null,
    enderecos: null,
    vendedores: null,
    parceirosBV: null,
    tiposEvento: null,
    duracoes: null,
    projetos: null
  };

  let eventoAtual = null;
  let eventoOriginal = null;
  let buscaExecucaoId = 0;
  let globalLoadingTimer = null;
  let globalLoadingSlowTimer = null;
  let __dropdownsProntos = {
    tipoEvento: false,
    duracao: false,
    projeto: false
  };
  let contratantesCache = [];
  let permissaoFinanceira = null;

  function mostrarLoadingGlobal(texto) {
    const overlay = document.getElementById('globalLoading');
    const label = document.getElementById('globalLoadingText');
    if (label && texto) label.textContent = texto;
    if (overlay) overlay.classList.add('show');
    document.body.setAttribute('aria-busy', 'true');

    clearTimeout(globalLoadingSlowTimer);
    clearTimeout(globalLoadingTimer);

    globalLoadingSlowTimer = setTimeout(() => {
      if (label && overlay && overlay.classList.contains('show')) {
        label.textContent = 'Processo em andamento... s√≥ mais um momento.';
      }
    }, 4000);

    globalLoadingTimer = setTimeout(() => {
      if (overlay && overlay.classList.contains('show')) {
        overlay.classList.remove('show');
        document.body.removeAttribute('aria-busy');
        if (document.body.dataset.loadingContext === 'busca') {
          travarBusca(false);
        }
        if (typeof mostrarAlerta === 'function') {
          mostrarAlerta('A opera√ß√£o est√° demorando mais que o normal. Tente novamente.', 'info');
        }
      }
    }, 18000);
  }

  function esconderLoadingGlobal() {
    const overlay = document.getElementById('globalLoading');
    if (overlay) overlay.classList.remove('show');
    document.body.removeAttribute('aria-busy');
    clearTimeout(globalLoadingSlowTimer);
    clearTimeout(globalLoadingTimer);
  }

function travarAcoes(travar = true) {
  document
    .querySelectorAll('#formEdicao button, #modalConfirmacao button')
    .forEach(btn => {
      btn.disabled = travar;
      if (travar) {
        btn.setAttribute('aria-busy', 'true');
      } else {
        btn.removeAttribute('aria-busy');
      }
    });
}

function aplicarSkeletonFormulario(ativo) {
  const form = document.getElementById('formEdicao');
  if (!form) return;
  form.classList.toggle('skeleton', !!ativo);
}

function travarBusca(travar = true) {
  const elementos = document.querySelectorAll(
    '.btn-search, .toggle-btn input, #inputID, #inputNome, #inputData, #inputPeriodo'
  );

  if (travar) {
    document.body.dataset.loadingContext = 'busca';
  } else if (document.body.dataset.loadingContext === 'busca') {
    delete document.body.dataset.loadingContext;
  }

  elementos.forEach(el => {
    if (travar) {
      if (el.dataset.prevDisabled === undefined) {
        el.dataset.prevDisabled = el.disabled ? '1' : '0';
      }
      el.disabled = true;
      el.setAttribute('aria-busy', 'true');
    } else {
      if (el.dataset.prevDisabled === '0') {
        el.disabled = false;
      }
      el.removeAttribute('aria-busy');
      delete el.dataset.prevDisabled;
    }
  });
}

function bloquearEdicaoFinanceira(motivo) {
  const campos = [
    'valorTotal',
    'valorBV',
    'idBV',
    'idVendedor',
    'temNF'
  ];

  campos.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.disabled = true;
    el.classList.add('campo-bloqueado');
  });

  // Limpa antes de adicionar novo status
  const statusFinanceiro = document.getElementById('statusFinanceiro');
  if (statusFinanceiro) statusFinanceiro.innerHTML = '';

  if (document.getElementById('avisoFinanceiroBloqueado')) return;

  const aviso = document.createElement('div');
  aviso.id = 'avisoFinanceiroBloqueado';
  aviso.className = 'status-box danger';
  aviso.innerHTML = `
    <span class="status-icon">üîí</span>
    <div>
      <strong>Edi√ß√£o financeira bloqueada</strong><br>
      ${motivo || 'Evento j√° possui recebimento registrado.'}
    </div>
  `;

  if (statusFinanceiro) {
    statusFinanceiro.prepend(aviso);
  }
}

// ============================
// BLOCO 2 ‚Äî DATAS E CONFLITOS
// ============================

// Converte Date / string da planilha para input[type=date]
function normalizarDataParaInput(data) {
  if (!data) return '';
  if (data instanceof Date) {
    const y = data.getFullYear();
    const m = String(data.getMonth() + 1).padStart(2, '0');
    const d = String(data.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }
  if (typeof data === 'string') {
    // yyyy-mm-dd (j√° ok)
    if (/^\d{4}-\d{2}-\d{2}$/.test(data)) return data;
    // dd/mm/yyyy
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(data)) {
      const [d, m, y] = data.split('/');
      return `${y}-${m}-${d}`;
    }
  }
  return '';
}

function toggleDataFimEdicao() {
  const chk = document.getElementById('eventoMultiDias');
  const grupo = document.getElementById('grupoDataFim');
  if (!chk || !grupo) return;

  grupo.classList.toggle('hidden', !chk.checked);

  if (!chk.checked) {
    document.getElementById('dataFim').value = '';
  }

  verificarConflitosEdicao();
}


let verificadorExecucaoId = 0;

function verificarConflitosEdicao() {
  if (!eventoOriginal) return;

  const dataInicio = document.getElementById('dataEvento')?.value;
  if (!dataInicio) {
    renderizarConflitosEdicao([]);
    return;
  }

  const multiDias = document.getElementById('eventoMultiDias')?.checked;
  const dataFimCampo = document.getElementById('dataFim');
  const dataFim = multiDias && dataFimCampo?.value ? dataFimCampo.value : dataInicio;

  verificadorExecucaoId++;
  const execucaoAtual = verificadorExecucaoId;

  function gerarIntervaloDatas(inicio, fim) {
    const datas = [];
    let atual = new Date(inicio + 'T12:00:00');
    const final = new Date(fim + 'T12:00:00');

    while (atual <= final) {
      datas.push(atual.toISOString().slice(0, 10));
      atual.setDate(atual.getDate() + 1);
    }
    return datas;
  }

  const datasParaVerificar = gerarIntervaloDatas(dataInicio, dataFim);

  let conflitos = [];
  let concluidas = 0;

  datasParaVerificar.forEach(data => {
    Auth.apiCall('buscarEventosPorData', {
      data: data
    })
    .then(eventos => {
      if (execucaoAtual !== verificadorExecucaoId) return;

      if (Array.isArray(eventos)) {
        eventos.forEach(ev => {
          if (String(ev.id) !== String(eventoOriginal.id)) {
            const chave = ev.id + '|' + ev.data + '|' + (ev.dataFim || '');
            if (!conflitos.some(c => c.__chave === chave)) {
              conflitos.push({ ...ev, __chave: chave });
            }
          }
        });
      }

      concluidas++;
      if (concluidas === datasParaVerificar.length) {
        renderizarConflitosEdicao(conflitos);
      }
    })
    .catch(err => {
      console.error('Erro ao verificar conflitos:', err);
      concluidas++;
      if (concluidas === datasParaVerificar.length) {
        renderizarConflitosEdicao(conflitos);
      }
    });
  });
}

function renderizarConflitosEdicao(eventos) {
  const container = document.getElementById('statusAgenda');
  if (!container) return;

  if (!eventos || eventos.length === 0) {
    container.innerHTML =
      '<div class="status-box safe">üü¢ Nenhum conflito de agenda detectado</div>';
    return;
  }

  let html = `
    <div class="status-box danger">
      <strong>‚ö†Ô∏è Conflitos de agenda detectados:</strong>
      <ul style="margin-top:8px;">
  `;

  eventos.forEach(ev => {
    html += `
      <li>
        ${ev.tipoRegistro || 'Evento'} ‚Äî
        ${ev.data}${ev.dataFim ? ' at√© ' + ev.dataFim : ''}
        ${ev.nomeLocal ? 'üìç ' + ev.nomeLocal : ''}
      </li>
    `;
  });

  html += '</ul></div>';
  container.innerHTML = html;
}

function setValueSafe(id, valor, tentativas = 0) {
  const el = document.getElementById(id);
  if (!el) return;

  if (valor === null || valor === undefined) return;

  const valorNormalizado = String(valor).trim().toLowerCase();

  const optionEncontrada = Array.from(el.options).find(o =>
    String(o.value).trim().toLowerCase() === valorNormalizado
  );

  if (optionEncontrada) {
    el.value = optionEncontrada.value;
    return;
  }

  if (tentativas < 20) {
    setTimeout(() => setValueSafe(id, valor, tentativas + 1), 100);
  }
}
    
async function iniciarEditarEvento() {
  try {
    fecharModal();
    await carregarContratantesParaAutocomplete();
    // carregar dados base ap√≥s auth OK
    carregarDropdowns();

    EVENTO_ID_URL = getIdEventoFromURL();

    if (EVENTO_ID_URL) {
      mostrarAlerta('Carregando evento...', 'info');
      const evento = await carregarEventoPorId(EVENTO_ID_URL);
      eventoAtual = evento;
      eventoOriginal = JSON.parse(JSON.stringify(evento));
      document.querySelector('.search-section').style.display = 'none';
      document.getElementById('formEdicao').classList.remove('hidden');
      mostrarAlerta('Evento carregado pela URL.', 'success');
    }
  } catch (err) {
    console.error('AUTH ERROR:', err);
    alert('Sess√£o expirada. Volte ao menu.');
    window.location.href = 'index.html';
  }
}
    
    // TOGGLE DE TIPO DE BUSCA
   function trocarTipoBusca(tipo) {
  // remove ativos
  document.querySelectorAll('.search-field-group').forEach(g => g.classList.remove('active'));
  document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));

  // ativa grupo
  const grupo = document.getElementById(
    'searchBy' + tipo.charAt(0).toUpperCase() + tipo.slice(1)
  );
  if (grupo) grupo.classList.add('active');

  // ativa bot√£o corretamente (sem usar event)
  const radio = document.querySelector(`input[name="searchType"][value="${tipo}"]`);
  if (radio) {
    const btn = radio.closest('.toggle-btn');
    if (btn) btn.classList.add('active');
  }

  // limpa resultados
  document.getElementById('resultsSection').classList.remove('show');
}
    // BUSCAR EVENTO (dispatcher)
    function buscarEvento() {
      const tipo = document.querySelector('input[name="searchType"]:checked').value;
      
      switch(tipo) {
        case 'id':
          buscarPorID();
          break;
        case 'nome':
          buscarPorNome();
          break;
        case 'data':
          buscarPorData();
          break;
        case 'periodo':
          buscarPorPeriodo();
          break;
      }
    }
    
    // BUSCA POR ID
    async function buscarPorID() {
      const id = document.getElementById('inputID').value.trim();
      console.log('üîç buscarPorID:', id);

      if (!id) {
        mostrarAlerta('Digite um ID para buscar', 'error');
        return;
      }

      const execId = ++buscaExecucaoId;
      travarBusca(true);
      mostrarLoading();

      let resultado = null;
      try {
        resultado = await Auth.apiCall('buscarEventoPorID', {
          idEvento: id
        });

      } catch (erro) {
        console.error('‚ùå Erro:', erro);
        if (execId === buscaExecucaoId) {
          mostrarAlerta('Erro ao buscar evento', 'error');
        }
      } finally {
        if (execId === buscaExecucaoId) {
        
          travarBusca(false);
          mostrarResultados(resultado);
        }
      }
    }

// Helper para carregar evento por id (usado na inicializa√ß√£o por URL)
async function carregarEventoPorId(idEvento) {
  const response = await Auth.apiCall('buscarEventoParaEdicao', {
    idEvento: idEvento
  });

  if (!response || !response.sucesso) {
    throw new Error(response?.mensagem || 'Evento n√£o encontrado');
  }

  return response.evento;
}
    
    // BUSCA POR NOME
    async function buscarPorNome() {
      const nome = document.getElementById('inputNome').value.trim();
      console.log('üîç buscarPorNome: Nome =', nome);
      if (!nome) {
        mostrarAlerta('Digite um nome para buscar', 'error');
        return;
      }
      const execId = ++buscaExecucaoId;
      travarBusca(true);
      mostrarLoading();
      let response = null;
      try {
        response = await Auth.apiCall('buscarEventoPorContratante', {
          nome: nome
        });
        if (response && response.error) {
          throw new Error(response.error);
        }
      } catch (erro) {
        console.error('‚ùå Erro:', erro);
        if (execId === buscaExecucaoId) {
          mostrarAlerta('Erro ao buscar evento', 'error');
        }
      } finally {
        if (execId === buscaExecucaoId) {
          
          travarBusca(false);
          mostrarResultados(response);
        }
      }
    }
    
    // BUSCA POR DATA
    async function buscarPorData() {
      const data = document.getElementById('inputData').value;
      console.log('üîç buscarPorData: Data =', data);
      if (!data) {
        mostrarAlerta('Selecione uma data', 'error');
        return;
      }
      const execId = ++buscaExecucaoId;
      travarBusca(true);
    
      mostrarLoading();
      let response = null;
      try {
        response = await Auth.apiCall('buscarEventoPorData', {
          data: data
        });
        if (response && response.error) {
          throw new Error(response.error);
        }
      } catch (erro) {
        console.error('‚ùå Erro:', erro);
        if (execId === buscaExecucaoId) {
          mostrarAlerta('Erro ao buscar evento', 'error');
        }
      } finally {
        if (execId === buscaExecucaoId) {
         
          travarBusca(false);
          mostrarResultados(response);
        }
      }
    }
    
    // BUSCA POR PER√çODO
    async function buscarPorPeriodo() {
      const periodo = document.getElementById('inputPeriodo').value;
      console.log('üîç buscarPorPeriodo: Per√≠odo =', periodo);
      if (!periodo) {
        mostrarAlerta('Selecione um per√≠odo', 'error');
        return;
      }
      const execId = ++buscaExecucaoId;
      travarBusca(true);
    
      mostrarLoading();
      let response = null;
      try {
        response = await Auth.apiCall('buscarEventoPorPeriodo', {
          periodo: periodo
        });
        if (response && response.error) {
          throw new Error(response.error);
        }
      } catch (erro) {
        console.error('‚ùå Erro:', erro);
        if (execId === buscaExecucaoId) {
          mostrarAlerta('Erro ao buscar evento', 'error');
        }
      } finally {
        if (execId === buscaExecucaoId) {
       
          travarBusca(false);
          mostrarResultados(response);
        }
      }
    }
    
    // AUTOCOMPLETE
    async function carregarContratantesParaAutocomplete() {
      try {
        if (window.__CACHE.contratantes) {
          contratantesCache = window.__CACHE.contratantes;
          return;
        }
        const lista = await Auth.apiCall('listarContratantes', {});
        if (lista && lista.error) throw new Error(lista.error);
        window.__CACHE.contratantes = lista;
        contratantesCache = lista;
      } catch (erro) {
        contratantesCache = [];
        console.error('Erro ao carregar contratantes:', erro);
      }
    }
    
 // ===============================
// AUTOCOMPLETE COM DEBOUNCE
// ===============================
let autocompleteTimer = null;

function autocompleteContratante(termo) {
  clearTimeout(autocompleteTimer);

  autocompleteTimer = setTimeout(() => {
    executarAutocompleteContratante(termo);
  }, 200);
}

function executarAutocompleteContratante(termo) {
  const list = document.getElementById('autocompleteList');

  if (!termo || termo.length < 2) {
    list.classList.remove('show');
    return;
  }

  const termoLower = termo.toLowerCase();

  const matches = contratantesCache
    .filter(c => c.nome.toLowerCase().includes(termoLower))
    .slice(0, 10);

  if (!matches.length) {
    list.classList.remove('show');
    return;
  }

  list.innerHTML = '';
  matches.forEach(c => {
    const item = document.createElement('div');
    item.className = 'autocomplete-item';
    item.textContent = c.nome;
    item.onclick = () => {
      document.getElementById('inputNome').value = c.nome;
      list.classList.remove('show');
    };
    list.appendChild(item);
  });

  list.classList.add('show');
}
    
    // Fecha autocomplete ao clicar fora
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.autocomplete-wrapper')) {
        document.getElementById('autocompleteList').classList.remove('show');
      }
    });
    
    // MOSTRAR LOADING
    function mostrarLoading() {
      const section = document.getElementById('resultsSection');
      const list = document.getElementById('resultsList');
      const count = document.getElementById('resultsCount');

      section.classList.add('show');
      list.innerHTML = '';
      if (count) count.textContent = '';

      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading';
      loadingDiv.innerHTML = `
        <div class="spinner"></div>
        <p>Buscando eventos...</p>
      `;

      list.appendChild(loadingDiv);
    }
    
    // MOSTRAR RESULTADOS
    function mostrarResultados(eventos) {
  const section = document.getElementById('resultsSection');
  const list = document.getElementById('resultsList');
  const count = document.getElementById('resultsCount');

  section.classList.add('show');

  // ‚úÖ CORRE√á√ÉO 1 ‚Äî backend inv√°lido
  if (!Array.isArray(eventos)) {
    list.innerHTML = '<div class="empty-state">Erro ao buscar eventos.</div>';
    count.textContent = '';
    return;
  }

  // ‚úÖ CORRE√á√ÉO 2 ‚Äî retorno vazio expl√≠cito
  if (eventos.length === 0) {
    list.innerHTML = '<div class="empty-state">Nenhum evento encontrado para esse filtro.</div>';
    count.textContent = '0 resultados';
    return;
  }

  // fluxo normal (mant√©m seu layout)
  count.textContent = `${eventos.length} evento(s) encontrado(s)`;
  list.innerHTML = '';

  eventos.forEach(evento => {
    const card = document.createElement('div');
    card.className = 'result-card';

    card.innerHTML = `
      <div class="result-id">${evento.id}</div>

      <div class="result-main">
        ${evento.tipoEvento} ‚Äî ${evento.contratante}
      </div>

      <div class="result-details">
        <div class="result-detail">üìÖ ${evento.dataFormatada}</div>
        <div class="result-detail">
          üí∞ R$ ${Number(evento.valor || 0).toLocaleString('pt-BR', {
            minimumFractionDigits: 2
          })}
        </div>
      </div>

      <div class="result-actions">
        <button
          class="btn-card btn-edit"
          onclick="selecionarEvento('${evento.id}')">
          ‚úèÔ∏è Editar Evento
        </button>
      </div>
    `;

    list.appendChild(card);
  });
}
    
    // SELECIONAR EVENTO PARA EDI√á√ÉO
  async function selecionarEvento(idEvento) {
    console.log('üü¶ Selecionar evento:', idEvento);

    // FASE 1 ‚Äî feedback imediato
    mostrarLoadingGlobal('Carregando evento...');

    try {
      // ============================
      // FASE 2 ‚Äî BUSCA BACKEND
      // ============================
      const resultado = await Auth.apiCall('buscarEventoParaEdicao', {
        idEvento: idEvento
      });

      if (!resultado || !resultado.sucesso) {
        throw new Error(resultado?.mensagem || 'Erro ao carregar evento');
      }

      // snapshot seguro
      eventoAtual = resultado.evento;
      eventoOriginal = JSON.parse(JSON.stringify(resultado.evento));

      // ============================
      // FASE 3 ‚Äî PRELOAD DROPDOWNS
      // ============================
      await carregarDropdowns();

      // ============================
      // FASE 4 ‚Äî TRANSI√á√ÉO VISUAL
      // ============================
      // esconde busca, mostra formul√°rio com skeleton
      const search = document.querySelector('.search-section');
      if (search) search.style.display = 'none';

      const form = document.getElementById('formEdicao');
      if (form) {
        form.classList.remove('hidden');
        travarAcoes(true);
        aplicarSkeletonFormulario(true);
      }

      // ============================
      // FASE 5 ‚Äî PREPARA√á√ÉO DO FORM
      // ============================
      preencherFormulario(eventoAtual);

      // Permiss√£o financeira
      try {
        const permissao = await Auth.apiCall('verificarPermissaoEdicaoFinanceira', {
          idEvento: eventoAtual.id
        });
        permissaoFinanceira = permissao;

        const statusFinanceiro = document.getElementById('statusFinanceiro');
        if (statusFinanceiro) statusFinanceiro.innerHTML = '';

        if (permissao && !permissao.permitido) {
          if (permissao.bloqueio === 'MOVIMENTACAO_FINANCEIRA') {
            bloquearEdicaoFinanceira(permissao.motivo);
          }
        }

        if (permissao?.permitido) {
          if (statusFinanceiro) {
            statusFinanceiro.innerHTML = `
              <div class="status-box safe">
                <span class="status-icon">üü¢</span>
                <div><strong>Status Financeiro:</strong> Evento liberado para edi√ß√£o.</div>
              </div>
            `;
          }
        }
      } catch (errPerm) {
        console.error('Erro permiss√£o financeira:', errPerm);
      }

      // ============================
      // FASE 6 ‚Äî CONFLITOS DE AGENDA
      // ============================
      setTimeout(() => {
        ['dataEvento', 'dataFim', 'horaInicio', 'duracao'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.removeEventListener('change', verificarConflitosEdicao);
            el.addEventListener('change', verificarConflitosEdicao);
          }
        });
        verificarConflitosEdicao();
      }, 200);

      // N√ÉO liberar a√ß√µes ou esconder loading aqui!

      console.log('‚úÖ Evento pronto para edi√ß√£o (aguardando dropdowns)');

    } catch (erro) {
      console.error('üî• Erro ao abrir edi√ß√£o:', erro);
      esconderLoadingGlobal();
      travarAcoes(false);
      mostrarAlerta(
        'Erro ao abrir evento: ' + (erro?.message || 'Erro desconhecido'),
        'error'
      );
    }
  }
// --- Valida√ß√£o de impacto financeiro antes de salvar ---
async function validarImpactoFinanceiroAntesSalvar(callback) {
  try {
    const resultado = await Auth.apiCall('validarAlteracoesEvento', {
      idEvento: eventoOriginal.id,
      ...coletarDadosFormulario()
    });
   if (resultado?.impactoFinanceiro?.risco === 'EXCESSO_GERADO') {
  mostrarAlerta(
    '‚ùå Altera√ß√£o bloqueada: j√° existe comiss√£o gerada maior que a nova comiss√£o calculada.',
    'error'
  );
  return;
}
    callback();
  } catch (err) {
    mostrarAlerta('Erro ao validar impacto financeiro: ' + (err && err.message ? err.message : err), 'error');
  }
}
    
    // Resto das fun√ß√µes (igual √† vers√£o anterior)
    async function carregarDropdowns() {
      try {
        let lista;
        if (!window.__CACHE.vendedores) {
          window.__CACHE.vendedores = await Auth.apiCall('listarVendedores', {});
        }
        lista = window.__CACHE.vendedores;
        if (lista && lista.error) throw new Error(lista.error);
        popularDropdown('idVendedor', lista);
      } catch (e) {}
      try {
        let lista;
        if (!window.__CACHE.parceirosBV) {
          window.__CACHE.parceirosBV = await Auth.apiCall('listarParceirosBV', {});
        }
        lista = window.__CACHE.parceirosBV;
        if (lista && lista.error) throw new Error(lista.error);
        popularDropdown('idBV', lista, true);
      } catch (e) {}
      // CONFIG - Tipo de Evento
      try {
        let tipos;
        if (!window.__CACHE.tiposEvento) {
          window.__CACHE.tiposEvento = await Auth.apiCall('listarTiposEvento', {});
        }
        tipos = window.__CACHE.tiposEvento;
        if (tipos && tipos.error) throw new Error(tipos.error);

        const sel = document.getElementById('tipoEvento');
        if (sel) {
          sel.innerHTML = '<option value="">Selecione...</option>';
          tipos.forEach(tipo => {
            const opt = document.createElement('option');
            opt.value = tipo;
            opt.textContent = tipo;
            sel.appendChild(opt);
          });
          __dropdownsProntos.tipoEvento = true;
          tentarPreencherEventoAposDropdowns();
        }
      } catch (e) {}
      // CONFIG - Dura√ß√µes
      try {
        let duracoes;
        if (!window.__CACHE.duracoes) {
          window.__CACHE.duracoes = await Auth.apiCall('listarDuracoesPadrao', {});
        }
        duracoes = window.__CACHE.duracoes;
        if (duracoes && duracoes.error) throw new Error(duracoes.error);

        const sel = document.getElementById('duracao');
        if (sel) {
          sel.innerHTML = '<option value="">Selecione...</option>';
          duracoes.forEach(min => {
            const minutos = Number(min);
            const h = Math.floor(minutos / 60);
            const m = minutos % 60;
            const label = m > 0 ? `${h}h${m}` : `${h}h`;

            const opt = document.createElement('option');
            opt.value = String(minutos); // üîë value = 120
            opt.textContent = label;     // label = 2h
            sel.appendChild(opt);
          });
          __dropdownsProntos.duracao = true;
          tentarPreencherEventoAposDropdowns();
        }
      } catch (e) {}
      // CONFIG - Projetos
      try {
        let projetos;
        if (!window.__CACHE.projetos) {
          window.__CACHE.projetos = await Auth.apiCall('listarProjetosSugeridos', {});
        }
        projetos = window.__CACHE.projetos;
        if (projetos && projetos.error) throw new Error(projetos.error);

        const sel = document.getElementById('projeto');
        if (sel) {
          sel.innerHTML = '<option value="">Selecione...</option>';
          projetos.forEach(proj => {
            const v = String(proj).trim();
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            sel.appendChild(opt);
          });
          __dropdownsProntos.projeto = true;
          tentarPreencherEventoAposDropdowns();
        }
      } catch (e) {}
    }
    
    function tentarPreencherEventoAposDropdowns() {
  if (!eventoAtual) return;

  if (
    !__dropdownsProntos.tipoEvento ||
    !__dropdownsProntos.duracao ||
    !__dropdownsProntos.projeto
  ) return;

  preencherFormulario(eventoAtual);
  aplicarSkeletonFormulario(false);
  esconderLoadingGlobal();
  travarAcoes(false);
}

    function popularDropdown(id, lista, opcional = false) {
      const select = document.getElementById(id);
      if (!opcional) select.innerHTML = '';
      lista.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.nome;
        select.appendChild(option);
      });
    }
    
    function preencherFormulario(evento) {
  // Campos de data e hora
  document.getElementById('dataEvento').value = evento.dataEvento || '';
  document.getElementById('horaInicio').value = evento.horaInicio || '';

  // DATA_FIM multi-dias
  if (evento.dataFim) {
    document.getElementById('eventoMultiDias').checked = true;
    document.getElementById('grupoDataFim').classList.remove('hidden');
    document.getElementById('dataFim').value =
  evento.dataFim || '';
  } else {
    document.getElementById('eventoMultiDias').checked = false;
    document.getElementById('grupoDataFim').classList.add('hidden');
    document.getElementById('dataFim').value = '';
  }

  // AUTOCOMPLETE CAMPOS: Contratante, Cerimonialista, Endere√ßo
  const c = window.__CACHE.autocomplete.contratantes.find(x => x.id == evento.idContratante);
  if (c) {
    document.getElementById('contratanteNome').value = c.nome;
    document.getElementById('idContratante').value = c.id;
  }
  const ce = window.__CACHE.autocomplete.cerimonialistas.find(x => x.id == evento.idCerimonialista);
  if (ce) {
    document.getElementById('cerimonialistaNome').value = ce.nome;
    document.getElementById('idCerimonialista').value = ce.id;
  }
  const e = window.__CACHE.autocomplete.enderecos.find(x => x.id == evento.idEndereco);
  if (e) {
    document.getElementById('enderecoNome').value = e.nome;
    document.getElementById('idEndereco').value = e.id;
  }
  // Outros selects
  setValueSafe('idVendedor', evento.idVendedor);
  setValueSafe('idBV', evento.idBV);
  setValueSafe('tipoEvento', evento.tipoEvento);
  setValueSafe('duracao', evento.duracao);
  setValueSafe('projeto', evento.projeto);
  setValueSafe('temNF', evento.temNF || 'N√ÉO');

  // Campos simples
  document.getElementById('valorTotal').value = evento.valorTotal || 0;
  document.getElementById('valorBV').value = evento.valorBV || 0;
  document.getElementById('look').value = evento.look || '';
  document.getElementById('somResponsavel').value = evento.somResponsavel || '';
  document.getElementById('observacoes').value = evento.observacoes || '';
  
  // Calcular hor√°rio fim ap√≥s carregar os dados
  setTimeout(calcularHorarioFim, 300);
}
  // ========================================
  // AUTOCOMPLETE - CACHE E FUN√á√ïES
  // ========================================
  window.__CACHE.autocomplete = {
    contratantes: [],
    cerimonialistas: [],
    enderecos: []
  };

  async function preloadAutocompleteData() {
    if (!window.__CACHE.autocomplete.contratantes.length) {
      window.__CACHE.autocomplete.contratantes =
        await Auth.apiCall('listarContratantes', {});
    }

    if (!window.__CACHE.autocomplete.cerimonialistas.length) {
      window.__CACHE.autocomplete.cerimonialistas =
        await Auth.apiCall('listarCerimonialistas', {});
    }

    if (!window.__CACHE.autocomplete.enderecos.length) {
      window.__CACHE.autocomplete.enderecos =
        await Auth.apiCall('listarEnderecos', {});
    }
  }

  function criarAutocomplete(inputId, hiddenId, listId, dataset) {
    let timer = null;
    const input = document.getElementById(inputId);
    const hidden = document.getElementById(hiddenId);
    const list = document.getElementById(listId);

    input.addEventListener('input', () => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        const termo = input.value.toLowerCase().trim();
        if (termo.length < 2) {
          list.classList.remove('show');
          return;
        }

        const matches = dataset
          .filter(i => i.nome.toLowerCase().includes(termo))
          .slice(0, 10);

        list.innerHTML = '';
        matches.forEach(item => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.textContent = item.nome;
          div.onclick = () => {
            input.value = item.nome;
            hidden.value = item.id;
            list.classList.remove('show');
          };
          list.appendChild(div);
        });

        list.classList.toggle('show', matches.length > 0);
      }, 250);
    });
    // Fecha lista ao clicar fora
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.autocomplete-wrapper')) {
        list.classList.remove('show');
      }
    });
  }
    
  // mostrarStatusFinanceiro REMOVIDA: nenhuma fun√ß√£o deve mais escrever na div #statusFinanceiro, exceto l√≥gica de permiss√£o financeira.
    
    async function validarEMostrarResumo() {
      if (!eventoOriginal || !eventoAtual) {
        mostrarAlerta('‚ùå Nenhum evento selecionado!', 'error');
        return;
      }
      const alteracoes = detectarAlteracoes();
      if (alteracoes.length === 0) {
        mostrarAlerta('‚ÑπÔ∏è Nenhuma altera√ß√£o detectada', 'info');
        return;
      }
      const lista = document.getElementById('listaAlteracoes');
      lista.innerHTML = '';
      alteracoes.forEach(alt => {
        const li = document.createElement('li');
        li.className = 'change-item';
        let html = `
          <div class="change-field">${alt.campo}</div>
          <div class="change-values">
            <span class="change-old">${alt.valorAntigo}</span> ‚Üí 
            <span class="change-new">${alt.valorNovo}</span>
          </div>
        `;
        if (alt.impacto) html += `<div class="change-impact">üí° ${alt.impacto}</div>`;
        li.innerHTML = html;
        lista.appendChild(li);
      });
      mostrarLoadingGlobal('Gerando resumo das altera√ß√µes...');
      travarAcoes(true);
      try {
        const resultado = await Auth.apiCall('validarAlteracoesEvento', {
          idEvento: eventoOriginal.id,
          ...coletarDadosFormulario()
        });
        mostrarResumoValidacoes(resultado);
        abrirModal();
        esconderLoadingGlobal();
        travarAcoes(false);
      } catch (erro) {
        esconderLoadingGlobal();
        travarAcoes(false);
        mostrarAlerta('Erro: ' + (erro && erro.message ? erro.message : erro), 'error');
      }
    }
    
    function detectarAlteracoes() {
      const alteracoes = [];
      const dados = coletarDadosFormulario();
      const campos = {
        dataEvento: 'Data do Evento', horaInicio: 'Hora de In√≠cio',
        duracao: 'Dura√ß√£o', tipoEvento: 'Tipo de Evento', projeto: 'Formato/Projeto',
        idContratante: 'Contratante', idCerimonialista: 'Cerimonialista', idEndereco: 'Local',
        valorTotal: 'Valor Total', idVendedor: 'Vendedor', valorBV: 'Valor BV',
        idBV: 'Parceiro BV', temNF: 'Tem NF',
        look: 'Look', somResponsavel: 'Respons√°vel Som', observacoes: 'Observa√ß√µes'
      };
      const impactos = {
        valorTotal: 'Comiss√µes pendentes ser√£o recalculadas',
        valorBV: 'Base de comiss√£o ser√° recalculada',
        idVendedor: 'Pode transferir comiss√µes pendentes',
        dataEvento: 'Verificar conflitos na agenda',
        horaInicio: 'Verificar conflitos na agenda'
      };
      const camposForcados = ['idContratante','idEndereco'];
      for (let campo in campos) {
        const el = document.getElementById(campo);
        // ‚úÖ NOVO: se campo est√° desabilitado, ignora
        if (el && el.disabled) {
          continue;
        }
        const valorAntigo = String(eventoOriginal[campo] ?? '');
        const valorNovo = String(dados[campo] ?? '');
        if (valorAntigo !== valorNovo || camposForcados.includes(campo)) {
          alteracoes.push({
            campo: campos[campo],
            valorAntigo: valorAntigo || '(vazio)',
            valorNovo: valorNovo || '(vazio)',
            impacto: impactos[campo] || null
          });
        }
      }
      return alteracoes;
    }
    
    function mostrarResumoValidacoes(resultado) {
      const resumo = document.getElementById('resumoValidacoes');
      let html = '';
      if (resultado.avisos?.length) resultado.avisos.forEach(a => html += `<div class="validation-item">‚ö†Ô∏è ${a}</div>`);
      if (resultado.conflitos?.length) resultado.conflitos.forEach(c => html += `<div class="validation-item" style="color: #dc3545;">üî¥ ${c}</div>`);
      if (!resultado.avisos?.length && !resultado.conflitos?.length) html = '<div class="validation-item">‚úÖ Sem conflitos detectados</div>';
      resumo.innerHTML = html;
    }
    
    function coletarDadosFormulario() {
      // Detectar se "Evento com mais de um dia" est√° marcado
      const multiDias = document.getElementById('eventoMultiDias')?.checked;
      const dataFim = multiDias
        ? document.getElementById('dataFim')?.value || ''
        : '';
      return {
        dataEvento: document.getElementById('dataEvento').value,
        dataFim: dataFim,
        horaInicio: document.getElementById('horaInicio').value,
        duracao: document.getElementById('duracao').value,
        tipoEvento: document.getElementById('tipoEvento').value,
        projeto: document.getElementById('projeto').value,
        idContratante: document.getElementById('idContratante').value,
        idCerimonialista: document.getElementById('idCerimonialista').value,
        idEndereco: document.getElementById('idEndereco').value,
        valorTotal: parseFloat(document.getElementById('valorTotal').value) || 0,
        idVendedor: document.getElementById('idVendedor').value,
        valorBV: parseFloat(document.getElementById('valorBV').value) || 0,
        idBV: document.getElementById('idBV').value,
        temNF: document.getElementById('temNF').value,
        look: document.getElementById('look').value,
        somResponsavel: document.getElementById('somResponsavel').value,
        observacoes: document.getElementById('observacoes').value
      };
    }
    
    async function confirmarEdicao() {
      // 1) Mostra loading e trava a√ß√µes imediatamente ao clicar
      mostrarLoadingGlobal('Salvando altera√ß√µes...');
      travarAcoes(true);
      fecharModal();
      mostrarAlerta('Validando impacto financeiro...', 'info');
      await validarImpactoFinanceiroAntesSalvar(async function () {
        // 2) Removido mostrarLoadingGlobal/travarAcoes duplicado aqui
        try {
          const dadosFormulario = coletarDadosFormulario();
          const resultado = await Auth.apiCall('salvarEdicaoEvento', {
            idEvento: eventoOriginal.id,
            ...dadosFormulario
          });
          if (resultado && resultado.sucesso) {
            esconderLoadingGlobal();
            travarAcoes(false);
            document.getElementById('successCard').classList.remove('hidden');
          } else {
            esconderLoadingGlobal();
            travarAcoes(false);
            mostrarAlerta(
              '‚ùå ' + (resultado?.mensagem || 'Erro ao salvar'),
              'error'
            );
          }
        } catch (erro) {
          esconderLoadingGlobal();
          travarAcoes(false);
          mostrarAlerta(
            'Erro: ' + (erro?.message || erro),
            'error'
          );
        }
      });
    }
    
    function abrirModal() {
      document.getElementById('modalConfirmacao').classList.add('show');
    }
    
    function fecharModal() {
      document.getElementById('modalConfirmacao').classList.remove('show');
    }
    
    function mostrarAlerta(mensagem, tipo) {
      const container = document.getElementById('alertContainer');
      const classe = tipo === 'success' ? 'alert-success' : tipo === 'error' ? 'alert-error' : 'alert-info';
      container.innerHTML = `<div class="alert ${classe}">${mensagem}</div>`;
      if (tipo === 'success' || tipo === 'info') {
        setTimeout(() => container.innerHTML = '', 5000);
      }
    }
    
    // ========================================
    // CALCULAR HOR√ÅRIO FIM
    // ========================================
   function calcularHorarioFim() {
  const horaInicio = document.getElementById('horaInicio')?.value;
  const duracao = parseInt(document.getElementById('duracao')?.value, 10);
  const box = document.getElementById('horarioFimCalc');

  if (!horaInicio || !duracao || duracao <= 0) {
    box.style.display = 'none';
    return;
  }

  const [h, m] = horaInicio.split(':').map(Number);
  const inicio = new Date();
  inicio.setHours(h, m, 0, 0);

  const fim = new Date(inicio.getTime() + duracao * 60000);

  const hf = String(fim.getHours()).padStart(2, '0');
  const mf = String(fim.getMinutes()).padStart(2, '0');

  box.textContent = `‚è∞ T√©rmino previsto: ${hf}:${mf}`;
  box.style.display = 'block';
}
    // ========================================
    // CORRIGIR BOT√ÉO VOLTAR
    // ========================================
    window.voltarParaBusca = function() {
      if (confirm('Descartar altera√ß√µes e voltar para a busca?')) {
        document.querySelector('.search-section').style.display = 'block';
        document.getElementById('formEdicao').classList.add('hidden');
        eventoAtual = null;
        eventoOriginal = null;
      }
    };
    
    // ========================================
    // EVENT LISTENERS PARA HOR√ÅRIO FIM
    // ========================================
    setTimeout(function() {
      const inputHora = document.getElementById('horaInicio');
      const inputDuracao = document.getElementById('duracao');
      
      if (inputHora) {
        inputHora.addEventListener('change', calcularHorarioFim);
      }
      if (inputDuracao) {
        inputDuracao.addEventListener('change', calcularHorarioFim);
      }
    }, 1000);

    // ========================================
    // BLOCO 2 ‚Äî DATAS/CONFLITOS: EVENT LISTENERS
    // ========================================
  
window.addEventListener('load', async () => {
  try {
    if (!window.Auth) throw new Error('AUTH_NOT_LOADED');
    const email = localStorage.getItem('auth_email');
    if (!email) throw new Error('NOT_AUTH');

    // Pr√©-carregar autocomplete e inicializar campos
    await preloadAutocompleteData();

    criarAutocomplete(
      'contratanteNome',
      'idContratante',
      'autocompleteContratanteList',
      window.__CACHE.autocomplete.contratantes
    );
    criarAutocomplete(
      'cerimonialistaNome',
      'idCerimonialista',
      'autocompleteCerimonialistaList',
      window.__CACHE.autocomplete.cerimonialistas
    );
    criarAutocomplete(
      'enderecoNome',
      'idEndereco',
      'autocompleteEnderecoList',
      window.__CACHE.autocomplete.enderecos
    );

    // Carregar outros dropdowns (exceto contratante/cerimonialista/endereco)
    await carregarDropdowns();
    await iniciarEditarEvento();
  } catch (err) {
    console.error('Erro de autentica√ß√£o:', err);
    alert('Sess√£o expirada. Volte ao menu.');
    window.location.href = 'index.html';
  }
});
  </script>

  <!-- Bottom Navigation ‚Äî Padr√£o Global -->
  <nav class="bottom-nav">
    <button class="bnav-item" onclick="window.location.href='index.html'">
      <i data-lucide="layout-grid"></i>
      <span>In√≠cio</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='agenda.html'">
      <i data-lucide="calendar-days"></i>
      <span>Agenda</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='cadastro-evento.html'">
      <i data-lucide="plus-circle"></i>
      <span>Novo</span>
    </button>
    <button class="bnav-item active">
      <i data-lucide="pencil-line"></i>
      <span>Editar</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='CentralFinanceira.html'">
      <i data-lucide="dollar-sign"></i>
      <span>Financeiro</span>
    </button>
  </nav>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    if (window.lucide) lucide.createIcons();
    var nome = localStorage.getItem('auth_nome') || '';
    var avatarEl = document.getElementById('ghAvatar');
    var nameEl = document.getElementById('ghName');
    if (avatarEl && nome) {
      var parts = nome.split(' ');
      avatarEl.textContent = parts.length >= 2
        ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase()
        : nome.substring(0,2).toUpperCase();
    }
    if (nameEl) nameEl.textContent = nome.split(' ')[0];
  });
  </script>
</body>
</html>

// ==== STUBS PARA CADASTRO R√ÅPIDO ====
function abrirCadastroRapidoContratante() {
  alert('Cadastro r√°pido de contratante ser√° aberto aqui.');
}

function abrirCadastroRapidoEndereco() {
  alert('Cadastro r√°pido de endere√ßo ser√° aberto aqui.');
}