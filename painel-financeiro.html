<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f1a2e"/>
  <title>Painel Financeiro</title>

  <script src="auth.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    /* ============================================
       GLOBAL NAV ‚Äî FA PRODU√á√ïES Design System
       ============================================ */
    :root {
      --nav-navy-900: #0a1628;
      --nav-navy-800: #0f1a2e;
      --nav-navy-700: #142240;
      --nav-navy-600: #1e3a5f;
      --nav-gold-500: #d4a853;
      --nav-gold-400: #e0bc6a;
      --nav-font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --nav-height: 68px;
      --nav-radius-md: 12px;
      --nav-radius-sm: 8px;
      --nav-radius-full: 999px;
    }

    .global-header {
      background: var(--nav-navy-800);
      color: white;
      padding: 0 20px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      position: sticky;
      top: 0;
      z-index: 200;
      font-family: var(--nav-font);
    }

    .global-header-brand {
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
      text-decoration: none; transition: opacity 0.2s;
    }
    .global-header-brand:hover { opacity: 0.85; }

    .global-header-back {
      width: 32px; height: 32px; border-radius: var(--nav-radius-sm);
      background: rgba(255,255,255,0.08); display: flex;
      align-items: center; justify-content: center; flex-shrink: 0;
      transition: background 0.2s;
    }
    .global-header-brand:hover .global-header-back { background: rgba(212,168,83,0.15); }
    .global-header-back i { color: var(--nav-gold-400); width: 18px; height: 18px; }

    .global-header-title {
      font-size: 15px; font-weight: 700; letter-spacing: -0.3px;
      display: flex; align-items: center; gap: 8px;
    }
    .global-header-title i { width: 20px; height: 20px; color: var(--nav-gold-400); }

    .global-header-user {
      display: flex; align-items: center; gap: 8px;
      padding: 4px 12px 4px 4px; background: rgba(255,255,255,0.06);
      border-radius: var(--nav-radius-full); border: 1px solid rgba(255,255,255,0.08);
      font-family: var(--nav-font);
    }

    .global-header-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      background: linear-gradient(135deg, var(--nav-navy-600), rgba(58,96,152,0.8));
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; color: var(--nav-gold-400); text-transform: uppercase;
    }

    .global-header-name {
      color: rgba(255,255,255,0.7); font-size: 12px; font-weight: 600;
      max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: var(--nav-height); background: var(--nav-navy-800);
      border-top: 1px solid rgba(255,255,255,0.06);
      display: flex; align-items: center; justify-content: space-around;
      z-index: 200; padding-bottom: env(safe-area-inset-bottom);
      font-family: var(--nav-font);
    }

    .bnav-item {
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      padding: 8px 14px; border-radius: var(--nav-radius-md);
      cursor: pointer; -webkit-tap-highlight-color: transparent;
      text-decoration: none; border: none; background: none; transition: all 0.2s;
    }
    .bnav-item i { width: 22px; height: 22px; color: rgba(255,255,255,0.55); transition: color 0.2s; }
    .bnav-item span { font-family: var(--nav-font); font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.55); transition: color 0.2s; }
    .bnav-item.active i, .bnav-item:hover i { color: var(--nav-gold-400); }
    .bnav-item.active span, .bnav-item:hover span { color: var(--nav-gold-400); }
    .bnav-item.active { background: rgba(212,168,83,0.08); }

    @media (min-width: 768px) { .bottom-nav { display: none; } body { padding-bottom: 0 !important; } }
    @media (max-width: 767px) { body { padding-bottom: calc(var(--nav-height) + 16px) !important; } }
  </style>

  <style>
    /* ============================================
       DESIGN SYSTEM ‚Äî FA PRODU√á√ïES (painel-financeiro)
       ============================================ */
    :root {
      --navy-900: #0a1628;
      --navy-800: #0f1a2e;
      --navy-700: #142240;
      --navy-600: #1e3a5f;
      --navy-500: #264a7a;
      --navy-400: #3a6098;
      --gold-600: #b8903e;
      --gold-500: #d4a853;
      --gold-400: #e0bc6a;
      --gold-300: #ebd08c;
      --gray-50: #f8f9fc;
      --gray-100: #f1f3f8;
      --gray-200: #e2e6ef;
      --gray-300: #cdd3e0;
      --gray-400: #9ca3b8;
      --gray-500: #6b7490;
      --gray-600: #4a5268;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 3px rgba(10,22,40,0.06);
      --shadow-md: 0 4px 16px rgba(10,22,40,0.08);
      --shadow-lg: 0 8px 32px rgba(10,22,40,0.14);

      /* Semantic aliases used by JS-generated classes */
      --primary: #1e3a5f;
      --secondary: #264a7a;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray: #e2e6ef;
      --dark: #1f2937;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font);
      background: var(--gray-50);
      color: var(--gray-800);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ============================================
       OLD HEADER (hidden, global-header replaces it)
       ============================================ */
    body > header {
      display: none;
    }

    /* ============================================
       MAIN CONTENT AREA
       ============================================ */
    .filtros,
    .modo-visual,
    .lista {
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
      padding-left: 20px;
      padding-right: 20px;
    }

    @media (min-width: 768px) {
      .filtros, .modo-visual, .lista {
        padding-left: 32px;
        padding-right: 32px;
      }
    }

    /* ============================================
       FILTROS (filter buttons)
       ============================================ */
    .filtros {
      display: flex;
      gap: 8px;
      margin-top: 24px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .modo-visual {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    /* ============================================
       LISTA CONTAINER
       ============================================ */
    .lista {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 32px;
    }

    /* ============================================
       CARDS (detailed view)
       ============================================ */
    .card {
      background: white;
      border-radius: var(--radius-md);
      padding: 18px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      border-left: 4px solid var(--gray-300);
    }

    .card.ok { border-left-color: var(--success); }
    .card.alerta { border-left-color: var(--warning); }
    .card.erro { border-left-color: var(--danger); }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
    }

    .titulo {
      font-weight: 700;
      color: var(--gray-800);
      font-size: 15px;
      letter-spacing: -0.2px;
    }

    .data {
      font-size: 12px;
      color: var(--gray-400);
      margin-top: 3px;
      font-weight: 500;
    }

    .valor {
      font-weight: 700;
      font-size: 15px;
      color: var(--navy-600);
      white-space: nowrap;
    }

    .linha {
      margin-top: 8px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      color: var(--gray-600);
    }

    .linha strong {
      color: var(--gray-800);
    }

    .status {
      margin-top: 10px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }

    .status.ok { color: var(--success); }
    .status.alerta { color: var(--warning); }
    .status.erro { color: var(--danger); }

    .alertas {
      margin-top: 8px;
      font-size: 12px;
      color: #92400e;
      font-weight: 500;
      line-height: 1.5;
      padding: 8px 10px;
      background: rgba(245,158,11,0.06);
      border-radius: 6px;
    }

    .acoes {
      margin-top: 14px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* ============================================
       COMISSAO BOX (inside cards)
       ============================================ */
    .comissao-box {
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--radius-sm);
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      font-size: 13px;
    }

    .comissao-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 8px;
    }

    .comissao-item {
      text-align: center;
    }

    .comissao-item span {
      display: block;
      font-size: 11px;
      color: var(--gray-400);
      font-weight: 500;
    }

    .comissao-item strong {
      font-size: 13px;
      color: var(--gray-800);
    }

    .comissao-status {
      margin-top: 8px;
      font-weight: 700;
      font-size: 12px;
    }

    .comissao-status.OK,
    .comissao-status.QUITADO { color: var(--success); }
    .comissao-status.PARCIAL,
    .comissao-status.PENDENTE,
    .comissao-status.AGUARDANDO { color: var(--warning); }
    .comissao-status.ERRO { color: var(--danger); }

    /* ============================================
       BUTTONS
       ============================================ */
    .btn {
      border: none;
      border-radius: var(--radius-sm);
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: -0.1px;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--navy-600), var(--navy-700));
      color: white;
    }

    .btn.warning {
      background: var(--warning);
      color: white;
    }

    .btn.success {
      background: var(--success);
      color: white;
    }

    .btn.secondary {
      background: var(--gray-100);
      color: var(--gray-600);
      border: 1px solid var(--gray-200);
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* ============================================
       LOADING
       ============================================ */
    .loading {
      text-align: center;
      padding: 48px 20px;
      color: var(--gray-400);
      font-weight: 600;
      font-size: 14px;
    }

    /* ============================================
       ESPELHO TABLE (mirror view)
       ============================================ */
    .espelho-container {
      overflow-x: auto;
      width: 100%;
      max-width: 100vw;
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch;
    }

    .espelho-table {
      width: 100%;
      min-width: 1100px;
      border-collapse: collapse;
      background: white;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }

    .espelho-table th,
    .espelho-table td {
      white-space: nowrap;
    }

    .espelho-header,
    .espelho-row {
      display: grid;
      grid-template-columns: 100px 1.5fr 1.2fr 120px 120px 120px 140px 100px;
      padding: 11px 14px;
    }

    .espelho-header {
      background: var(--navy-600);
      color: white;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }

    .espelho-row {
      border-top: 1px solid var(--gray-200);
      font-size: 13px;
      color: var(--gray-700);
      transition: background 0.15s;
    }

    .espelho-row:hover {
      background: var(--gray-50);
    }

    .espelho-row.ok { background: rgba(16,185,129,0.04); }
    .espelho-row.ok:hover { background: rgba(16,185,129,0.08); }
    .espelho-row.alerta { background: rgba(245,158,11,0.04); }
    .espelho-row.alerta:hover { background: rgba(245,158,11,0.08); }
    .espelho-row.erro { background: rgba(239,68,68,0.04); }
    .espelho-row.erro:hover { background: rgba(239,68,68,0.08); }
  </style>
</head>

<body>
  <!-- Global Header -->
  <div class="global-header">
    <a class="global-header-brand" onclick="window.location.href='index.html'" title="Voltar ao In√≠cio">
      <div class="global-header-back">
        <i data-lucide="arrow-left"></i>
      </div>
      <div class="global-header-title">
        <i data-lucide="bar-chart-3"></i>
        <span>Painel Financeiro</span>
      </div>
    </a>
    <div class="global-header-user">
      <div class="global-header-avatar" id="ghAvatar">--</div>
      <div class="global-header-name" id="ghName"></div>
    </div>
  </div>

<header>
  <h1>üìä Painel Financeiro</h1>
  <p>Vis√£o consolidada ‚Ä¢ Pend√™ncias ‚Ä¢ Alertas autom√°ticos</p>
</header>

<div class="filtros">
  <button class="btn secondary" onclick="aplicarFiltro('TODOS')">Todos</button>
  <button class="btn warning" onclick="aplicarFiltro('COMISSAO_PENDENTE')">üíº Comiss√£o pendente</button>
  <button class="btn warning" onclick="aplicarFiltro('COMISSAO_PROBLEMA')">üö® Problema de comiss√£o</button>
  <button class="btn success" onclick="aplicarFiltro('OK')">‚úÖ Sem pend√™ncias</button>
</div>
<div class="modo-visual">
  <button class="btn secondary" onclick="MODO_VISUAL='ESPELHO'; renderAtual();">üî≥ Espelho Financeiro</button>
  <button class="btn secondary" onclick="MODO_VISUAL='CARDS'; renderAtual();">üßæ Detalhado</button>
</div>

<div id="lista" class="lista">
  <div class="loading">Carregando sa√∫de financeira dos eventos...</div>
</div>

<script>
  let EVENTOS_CACHE = [];
  let FILTRO_ATUAL = 'TODOS';
  let MODO_VISUAL = 'ESPELHO';
  let listaFiltradaAtual = null;

  const ALERTAS_LABEL = {
    EVENTO_OCORREU_SEM_RECEBIMENTO: 'Evento j√° ocorreu e n√£o teve recebimento',
    EVENTO_OCORREU_RECEBIMENTO_PARCIAL: 'Evento ocorreu com recebimento parcial',
    INCONSISTENCIA_RECEBIDO_MAIOR_QUE_CONTRATO: 'Recebido maior que o valor do contrato',
    BV_PENDENTE: 'BV ainda n√£o foi pago',
    FOLHA_NAO_REGISTRADA: 'Folha de custos n√£o registrada',
    EVENTO_CANCELADO_COM_RECEBIMENTO: 'Evento cancelado com recebimento',
    COMISSAO_PENDENTE: 'Comiss√£o do vendedor pendente ou parcial',
    COMISSAO_INCONSISTENTE: 'Inconsist√™ncia grave na comiss√£o do vendedor',
    COMISSAO_NAO_PAGA_APOS_QUITACAO: 'Evento quitado, mas comiss√£o ainda n√£o foi paga',
    COMISSAO_PAGA_MAIOR_QUE_ESPERADO: 'Comiss√£o paga maior que o valor esperado',
    COMISSAO_GERADA_MAIOR_QUE_ESPERADO: 'Comiss√£o gerada maior que o valor esperado'
  };

  async function carregarPainel() {
    try {
      const resp = await Auth.apiCall('listarEventosFinanceiros');

      if (!resp) {
        document.getElementById('lista').innerHTML =
          '<div class="loading">Erro ao carregar painel financeiro.</div>';
        return;
      }

      const eventos = resp.eventos || resp;
      renderizarEventos(eventos);
    } catch (err) {
      console.error('Erro ao carregar painel financeiro:', err);
      document.getElementById('lista').innerHTML =
        '<div class="loading">Sess√£o expirada ou erro ao carregar dados.</div>';
    }
  }

  function renderizarEventos(eventos) {
    EVENTOS_CACHE = eventos;
    aplicarFiltro(FILTRO_ATUAL, false);
    return;
  }

  function aplicarFiltro(tipo, recarregar = true) {
    FILTRO_ATUAL = tipo;

    let lista = EVENTOS_CACHE;

    if (tipo === 'COMISSAO_PENDENTE') {
      lista = lista.filter(e =>
        e.comissao &&
        e.comissao.existe === true &&
        e.comissao.status === 'PENDENTE'
      );
    }

    if (tipo === 'COMISSAO_PROBLEMA') {
      lista = lista.filter(e =>
        e.comissao &&
        e.comissao.existe === true &&
        e.comissao.status === 'ERRO'
      );
    }

    if (tipo === 'OK') {
      lista = lista.filter(e =>
        e.status === 'ok' &&
        (!e.comissao || e.comissao.status === 'OK' || e.comissao.status === 'QUITADO' || e.comissao.status === 'NA')
      );
    }

    if (tipo === 'TODOS') {
      lista = EVENTOS_CACHE;
    }

    listaFiltradaAtual = lista;

    renderAtual();
  }

  function renderAtual(listaOverride) {
    const lista = listaOverride || listaFiltradaAtual || EVENTOS_CACHE;
    if (MODO_VISUAL === 'ESPELHO') {
      renderEspelho(lista);
    } else {
      renderCards(lista);
    }
  }

  function renderEspelho(lista) {
    const container = document.getElementById('lista');
    container.innerHTML = '';

    if (!lista.length) {
      container.innerHTML = '<div class="loading">Nenhum evento para este filtro.</div>';
      return;
    }

    const table = document.createElement('div');
    table.className = 'espelho-table';

    // Header
    const header = document.createElement('div');
    header.className = 'espelho-header';
    header.innerHTML = `
      <div>Data</div>
      <div>Evento</div>
      <div>Contratante</div>
      <div>Valor</div>
      <div>Recebido</div>
      <div>Pendente</div>
      <div>Comiss√£o</div>
      <div>Status</div>
    `;
    table.appendChild(header);

    lista.forEach(evento => {
      let statusSeguro = evento.status;

      if (evento.comissao?.status === 'ERRO') {
        statusSeguro = 'erro';
      } else if (
        evento.comissao?.status === 'PENDENTE' &&
        statusSeguro !== 'erro'
      ) {
        statusSeguro = 'alerta';
      }

      if (!['ok', 'alerta', 'erro'].includes(statusSeguro)) {
        statusSeguro = 'ok';
      }

      const row = document.createElement('div');
      row.className = `espelho-row ${statusSeguro}`;

      let comissaoText = 'N/A';
      if (evento.comissao && evento.comissao.existe) {
        switch (evento.comissao.status) {
          case 'AGUARDANDO':
            comissaoText = 'Aguardando';
            break;
          case 'PARCIAL':
          case 'PENDENTE':
            comissaoText = '‚ö†Ô∏è Pendente';
            break;
          case 'OK':
          case 'QUITADO':
            comissaoText = 'Quitada';
            break;
          case 'ERRO':
            comissaoText = 'Erro';
            break;
          default:
            comissaoText = 'N/A';
        }
      }

      row.innerHTML = `
        <div>${formatarData(evento.dataEvento)}</div>
        <div>${evento.nomeEvento}</div>
        <div>${evento.contratante || ''}</div>
        <div>R$ ${formatarValor(evento.valorContrato)}</div>
        <div>R$ ${formatarValor(evento.totalRecebido)}</div>
        <div>R$ ${formatarValor(evento.valorPendente)}</div>
        <div>${comissaoText}</div>
        <div>${statusSeguro.toUpperCase()}</div>
      `;

      table.appendChild(row);
    });

    container.appendChild(table);
  }

  function renderCards(lista) {
    const container = document.getElementById('lista');
    container.innerHTML = '';

    if (!lista.length) {
      container.innerHTML = '<div class="loading">Nenhum evento para este filtro.</div>';
      return;
    }

    lista.forEach(ev => container.appendChild(criarCard(ev)));
  }

  function criarCard(evento) {
    let statusSeguro = evento.status;

    if (evento.comissao?.status === 'ERRO') {
      statusSeguro = 'erro';
    } else if (
      evento.comissao?.status === 'PENDENTE' &&
      statusSeguro !== 'erro'
    ) {
      statusSeguro = 'alerta';
    }

    if (!['ok', 'alerta', 'erro'].includes(statusSeguro)) {
      statusSeguro = 'ok';
    }

    const card = document.createElement('div');
    card.className = `card ${statusSeguro}`;

    // Criar arrays separados para alertas por categoria
    const alertasFinanceiros = [];
    const alertasComissao = [];
    const alertasCustos = [];

    (evento.alertas || []).forEach(a => {
      const texto = ALERTAS_LABEL[a] || a;
      if ([
        'EVENTO_OCORREU_SEM_RECEBIMENTO',
        'EVENTO_OCORREU_RECEBIMENTO_PARCIAL',
        'INCONSISTENCIA_RECEBIDO_MAIOR_QUE_CONTRATO',
        'EVENTO_CANCELADO_COM_RECEBIMENTO'
      ].includes(a)) {
        alertasFinanceiros.push(texto);
      } else if ([
        'COMISSAO_PENDENTE',
        'COMISSAO_INCONSISTENTE',
        'COMISSAO_NAO_PAGA_APOS_QUITACAO',
        'COMISSAO_PAGA_MAIOR_QUE_ESPERADO',
        'COMISSAO_GERADA_MAIOR_QUE_ESPERADO'
      ].includes(a)) {
        // Exibir alertas de comiss√£o apenas se status n√£o for AGUARDANDO ou PARCIAL
        if (evento.comissao?.status !== 'AGUARDANDO' && evento.comissao?.status !== 'PARCIAL') {
          alertasComissao.push(texto);
        }
      } else if ([
        'BV_PENDENTE',
        'FOLHA_NAO_REGISTRADA'
      ].includes(a)) {
        alertasCustos.push(texto);
      }
    });

    card.innerHTML = `
      <div class="card-header">
        <div>
          <div class="titulo">${evento.nomeEvento}</div>
          <div class="data">${formatarData(evento.dataEvento)}</div>
        </div>
        <div class="valor">R$ ${formatarValor(evento.valorContrato)}</div>
      </div>

      <div class="linha">
        <span>Recebido</span>
        <strong>R$ ${formatarValor(evento.totalRecebido)}</strong>
      </div>

      <div class="linha">
        <span>Saldo a Receber</span>
        <strong>R$ ${formatarValor(evento.valorPendente)}</strong>
      </div>

      ${evento.comissao && evento.comissao.existe ? `
        <div class="comissao-box">
          <strong>üíº Comiss√£o do Vendedor</strong>

          <div class="comissao-grid">
            <div class="comissao-item">
              <span>Esperado</span>
              <strong>R$ ${formatarValor(evento.comissao.valores.esperado)}</strong>
            </div>
            <div class="comissao-item">
              <span>Gerado</span>
              <strong>R$ ${formatarValor(evento.comissao.valores.gerado)}</strong>
            </div>
            <div class="comissao-item">
              <span>Pago</span>
              <strong>R$ ${formatarValor(evento.comissao.valores.pago)}</strong>
            </div>
            <div class="comissao-item">
              <span>Pendente</span>
              <strong>R$ ${formatarValor(evento.comissao.valores.pendente)}</strong>
            </div>
          </div>

          <div class="comissao-status ${evento.comissao.status}">
            ${(() => {
              switch (evento.comissao.status) {
                case 'NA': return 'Comiss√£o: N√£o aplic√°vel';
                case 'AGUARDANDO': return '‚ÑπÔ∏è Comiss√£o ser√° gerada conforme os recebimentos';
                case 'PARCIAL': return '‚ÑπÔ∏è Comiss√£o parcialmente gerada';
                case 'PENDENTE': return '‚ö†Ô∏è Comiss√£o pendente de pagamento';
                case 'OK':
                case 'QUITADO': return '‚úÖ Comiss√£o quitada';
                case 'ERRO': return 'üö® Problema grave na comiss√£o';
                default: return 'Status de comiss√£o desconhecido';
              }
            })()}
          </div>
        </div>
      ` : ''}

      <div class="linha">
        <span>BV</span>
        <strong>${evento.bv?.status || 'N/A'}</strong>
      </div>

      <div class="linha">
        <span>Nota Fiscal</span>
        <strong>${evento.nf?.status || 'PROCESSADO'}</strong>
      </div>

      <div class="status ${statusSeguro}">
        Status: ${statusSeguro.toUpperCase()}
      </div>

      ${alertasFinanceiros.length ? `<div class="alertas"><strong>üí∞ Financeiro:</strong> ${alertasFinanceiros.join(' ‚Ä¢ ')}</div>` : ''}
      ${alertasComissao.length ? `<div class="alertas"><strong>üíº Comiss√£o:</strong> ${alertasComissao.join(' ‚Ä¢ ')}</div>` : ''}
      ${alertasCustos.length ? `<div class="alertas"><strong>üßæ Custos:</strong> ${alertasCustos.join(' ‚Ä¢ ')}</div>` : ''}

      <div class="acoes">
        ${evento.acoes?.podeReceber ? `<button class="btn success" onclick="irReceber('${evento.idEvento}')">Receber</button>` : ''}
        ${evento.acoes?.podePagarBV ? `<button class="btn warning" onclick="irPagarBV('${evento.idEvento}')">Pagar BV</button>` : ''}
        ${evento.acoes?.podeRegistrarFolha ? `<button class="btn secondary" onclick="irCustos('${evento.idEvento}')">Registrar Custos</button>` : ''}
      </div>
    `;

    return card;
  }

  function formatarValor(v) {
    return Number(v || 0).toFixed(2).replace('.', ',');
  }

  function formatarData(d) {
    if (!d) return '';

    // Caso j√° seja Date
    if (d instanceof Date && !isNaN(d.getTime())) {
      return d.toLocaleDateString('pt-BR');
    }

    // Caso venha como string DD/MM/YYYY
    if (typeof d === 'string' && d.includes('/')) {
      const partes = d.split('/');
      if (partes.length === 3) {
        const dia = Number(partes[0]);
        const mes = Number(partes[1]) - 1;
        const ano = Number(partes[2]);
        const data = new Date(ano, mes, dia);
        if (!isNaN(data.getTime())) {
          return data.toLocaleDateString('pt-BR');
        }
      }
      return d; // fallback seguro
    }

    // Caso ISO ou timestamp
    const data = new Date(d);
    if (isNaN(data.getTime())) return '';

    return data.toLocaleDateString('pt-BR');
  }

  function irReceber(id) {
    window.location.href = 'central-financeira.html';
  }

  function irPagarBV(id) {
    window.location.href = 'central-financeira.html';
  }

  function irCustos(id) {
    window.location.href = 'central-financeira.html';
  }

  

window.addEventListener('load', () => {
  console.log('üöÄ painel-financeiro.html iniciado (frontend externo)');
  carregarPainel();
});
</script>

  <!-- Bottom Navigation ‚Äî Padr√£o Global -->
  <nav class="bottom-nav">
    <button class="bnav-item" onclick="window.location.href='index.html'">
      <i data-lucide="layout-grid"></i>
      <span>In√≠cio</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='agenda.html'">
      <i data-lucide="calendar-days"></i>
      <span>Agenda</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='cadastro-evento.html'">
      <i data-lucide="plus-circle"></i>
      <span>Novo</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='editar-evento.html'">
      <i data-lucide="pencil-line"></i>
      <span>Editar</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='central-financeira.html'">
      <i data-lucide="dollar-sign"></i>
      <span>Financeiro</span>
    </button>
  </nav>

  <script>
  // Inicializa Lucide icons e header do usu√°rio
  document.addEventListener('DOMContentLoaded', function() {
    if (window.lucide) lucide.createIcons();
    var nome = localStorage.getItem('auth_nome') || '';
    var avatarEl = document.getElementById('ghAvatar');
    var nameEl = document.getElementById('ghName');
    if (avatarEl && nome) {
      var parts = nome.split(' ');
      avatarEl.textContent = parts.length >= 2
        ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase()
        : nome.substring(0,2).toUpperCase();
    }
    if (nameEl) nameEl.textContent = nome.split(' ')[0];
  });
  </script>
</body>
</html>
