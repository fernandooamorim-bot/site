<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #1a1a1a;
      margin-bottom: 10px;
      font-size: 24px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    /* BUSCA COM TOGGLE BUTTONS */
    .search-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 30px;
      border-left: 4px solid #0d47a1;
    }
    
    .search-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 20px;
    }
    
    /* TOGGLE BUTTONS */
    .toggle-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .toggle-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
      color: #666;
    }
    
    .toggle-btn:hover {
      border-color: #0d47a1;
      background: #f0f7ff;
    }
    
    .toggle-btn.active {
      background: #0d47a1;
      border-color: #0d47a1;
      color: white;
    }
    
    .toggle-btn input[type="radio"] {
      display: none;
    }
    
    .toggle-icon {
      font-size: 18px;
    }
    
    /* CAMPOS DE BUSCA DIN√ÇMICOS */
    .search-fields {
      min-height: 100px;
    }
    
    .search-field-group {
      display: none;
    }
    
    .search-field-group.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .search-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    
    .search-input-wrapper input,
    .search-input-wrapper select {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .btn-search {
      padding: 12px 24px;
      background: #0d47a1;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .btn-search:hover {
      background: #0a3275;
    }
    
    .helper-text {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
    
    /* AUTOCOMPLETE */
    .autocomplete-wrapper {
      position: relative;
      flex: 1;
    }
    
    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 4px 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .autocomplete-list.show {
      display: block;
    }
    
    .autocomplete-item {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .autocomplete-item:hover {
      background: #f0f7ff;
    }
    
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    
    /* RESULTADOS DA BUSCA */
    .results-section {
      margin-top: 25px;
      display: none;
    }
    
    .results-section.show {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .results-title {
      font-size: 16px;
      font-weight: 600;
      color: #0d47a1;
    }
    
    .results-count {
      font-size: 14px;
      color: #666;
    }
    
    .results-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .result-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .result-card:hover {
      border-color: #0d47a1;
      box-shadow: 0 2px 8px rgba(13, 71, 161, 0.1);
    }
    
    .result-id {
      font-size: 12px;
      color: #666;
      font-family: monospace;
      margin-bottom: 5px;
    }
    
    .result-main {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
    }
    
    .result-details {
      display: flex;
      gap: 20px;
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .result-detail {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .result-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-card {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-edit {
      background: #0d47a1;
      color: white;
    }
    
    .btn-edit:hover {
      background: #0a3275;
    }
    
    .btn-view {
      background: #f0f0f0;
      color: #666;
    }
    
    .btn-view:hover {
      background: #e0e0e0;
    }
    
    /* FORMUL√ÅRIO DE EDI√á√ÉO */
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }
    
    .label-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .indicator {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
    }
    
    .indicator-free {
      background: #d4edda;
      color: #155724;
    }
    
    .indicator-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .indicator-critical {
      background: #f8d7da;
      color: #721c24;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #0d47a1;
      box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1);
    }
    
    input:disabled, select:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .campo-bloqueado {
      background-color: #f5f5f5 !important;
      color: #777 !important;
      cursor: not-allowed;
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #0d47a1;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #0d47a1;
    }
    
    .status-box {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .status-box.safe {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .status-box.warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }
    
    .status-box.danger {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    .status-icon {
      font-size: 24px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #0d47a1;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0a3275;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #666;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #444;
    }
    
    .actions {
      margin-top: 30px;
      text-align: center;
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .hidden {
      display: none !important;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-overlay.show {
      display: flex;
    }
    
    .modal {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .changes-list {
      list-style: none;
      margin: 20px 0;
    }
    
    .change-item {
      padding: 12px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border-left: 4px solid #0d47a1;
      border-radius: 4px;
    }
    
    .change-field {
      font-weight: 600;
      color: #0d47a1;
      margin-bottom: 5px;
    }
    
    .change-values {
      font-size: 14px;
      color: #666;
    }
    
    .change-old {
      color: #dc3545;
      text-decoration: line-through;
    }
    
    .change-new {
      color: #28a745;
      font-weight: 600;
    }
    
    .change-impact {
      margin-top: 8px;
      padding: 8px;
      background: #fff3cd;
      border-radius: 4px;
      font-size: 13px;
      color: #856404;
    }
    
    .validation-summary {
      margin: 20px 0;
      padding: 15px;
      background: #e7f3ff;
      border-radius: 4px;
      border-left: 4px solid #0d47a1;
    }
    
    .validation-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .validation-item:last-child {
      margin-bottom: 0;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0d47a1;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚úèÔ∏è Editar Evento</h2>
    <p class="subtitle">Busque e edite eventos com valida√ß√µes autom√°ticas de seguran√ßa</p>
    
    <div id="alertContainer"></div>
    
    <!-- SE√á√ÉO DE BUSCA -->
    <div class="search-section">
      <div class="search-title">üîç Como voc√™ quer buscar o evento?</div>
      
      <!-- BOT√ïES TOGGLE -->
      <div class="toggle-buttons">
        <label class="toggle-btn active">
          <input type="radio" name="searchType" value="id" checked onchange="trocarTipoBusca('id')">
          <span class="toggle-icon">üî¢</span>
          <span>Por ID</span>
        </label>
        
        <label class="toggle-btn">
          <input type="radio" name="searchType" value="nome" onchange="trocarTipoBusca('nome')">
          <span class="toggle-icon">üë§</span>
          <span>Por Nome</span>
        </label>
        
        <label class="toggle-btn">
          <input type="radio" name="searchType" value="data" onchange="trocarTipoBusca('data')">
          <span class="toggle-icon">üìÖ</span>
          <span>Por Data</span>
        </label>
        
        <label class="toggle-btn">
          <input type="radio" name="searchType" value="periodo" onchange="trocarTipoBusca('periodo')">
          <span class="toggle-icon">üóìÔ∏è</span>
          <span>Por Per√≠odo</span>
        </label>
      </div>
      
      <!-- CAMPOS DIN√ÇMICOS -->
      <div class="search-fields">
        
        <!-- BUSCA POR ID -->
        <div id="searchById" class="search-field-group active">
          <div class="search-input-wrapper">
            <input type="text" id="inputID" placeholder="Ex: AG-20251228-001" 
                   onkeypress="if(event.key==='Enter') buscarEvento()">
            <button class="btn-search" onclick="buscarEvento()">üîç Buscar</button>
          </div>
          <p class="helper-text">üí° Digite o ID completo ou parcial (ex: AG-2025)</p>
        </div>
        
        <!-- BUSCA POR NOME -->
        <div id="searchByNome" class="search-field-group">
          <div class="search-input-wrapper">
            <div class="autocomplete-wrapper">
              <input type="text" id="inputNome" placeholder="Digite o nome do contratante..." 
                     oninput="autocompleteContratante(this.value)"
                     onkeypress="if(event.key==='Enter') buscarEvento()">
              <div id="autocompleteList" class="autocomplete-list"></div>
            </div>
            <button class="btn-search" onclick="buscarEvento()">üîç Buscar</button>
          </div>
          <p class="helper-text">üí° Digite parte do nome e selecione da lista</p>
        </div>
        
        <!-- BUSCA POR DATA -->
        <div id="searchByData" class="search-field-group">
          <div class="search-input-wrapper">
            <input type="date" id="inputData" onchange="buscarEvento()">
            <button class="btn-search" onclick="buscarEvento()">üîç Buscar</button>
          </div>
          <p class="helper-text">üí° Selecione a data do evento</p>
        </div>
        
        <!-- BUSCA POR PER√çODO -->
        <div id="searchByPeriodo" class="search-field-group">
          <div class="search-input-wrapper">
            <select id="inputPeriodo" onchange="buscarEvento()">
              <option value="">-- Selecione um per√≠odo --</option>
              <option value="ultimos-7">√öltimos 7 dias</option>
              <option value="ultimos-30">√öltimos 30 dias</option>
              <option value="este-mes">Este m√™s</option>
              <option value="mes-passado">M√™s passado</option>
              <option value="proximos">Pr√≥ximos eventos</option>
              <option value="este-ano">Este ano</option>
            </select>
            <button class="btn-search" onclick="buscarEvento()">üîç Buscar</button>
          </div>
          <p class="helper-text">üí° Filtre eventos por per√≠odo de tempo</p>
        </div>
        
      </div>
      
      <!-- RESULTADOS DA BUSCA -->
      <div id="resultsSection" class="results-section">
        <div class="results-header">
          <div class="results-title">üìä Resultados da Busca</div>
          <div class="results-count" id="resultsCount"></div>
        </div>
        <div id="resultsList" class="results-list"></div>
      </div>
    </div>
    
    <!-- FORMUL√ÅRIO DE EDI√á√ÉO (inicialmente oculto) -->
    <div id="formEdicao" class="hidden">
      
      <div id="statusAgenda"></div>
      <!-- STATUS FINANCEIRO -->
      <div id="statusFinanceiro"></div>
      
      <!-- DADOS DO EVENTO -->
      <div class="section">
        <div class="section-title">üìÖ Dados do Evento</div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Data do Evento</span>
              <span class="indicator indicator-warning">‚ö†Ô∏è Verifica conflitos</span>
            </label>
            <input type="date" id="dataEvento">
            <p class="helper-text">Altera√ß√£o verifica conflitos na agenda</p>
          </div>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="eventoMultiDias" onchange="toggleDataFimEdicao()">
            Evento com mais de um dia
          </label>
        </div>

        <div class="form-group hidden" id="grupoDataFim">
          <label class="label-indicator">
            <span>Data Fim</span>
            <span class="indicator indicator-warning">‚ö†Ô∏è Verifica conflitos</span>
          </label>
          <input type="date" id="dataFim">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Hora de In√≠cio</span>
              <span class="indicator indicator-warning">‚ö†Ô∏è Verifica conflitos</span>
            </label>
            <input type="time" id="horaInicio">
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Dura√ß√£o</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="duracao">
              <option value="">Selecione...</option>
            </select>
            <div id="horarioFimCalc" style="margin-top:8px;padding:8px;background:#e3f2fd;border-radius:4px;color:#0d47a1;font-weight:600;display:none;"></div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Tipo de Evento</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="tipoEvento">
              <option value="Casamento">Casamento</option>
              <option value="15 Anos">15 Anos</option>
              <option value="Corporativo">Corporativo</option>
              <option value="Anivers√°rio">Anivers√°rio</option>
              <option value="Formatura">Formatura</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Formato/Projeto</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="projeto">
              <option value="">Selecione...</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Contratante</span>
              <span class="indicator indicator-warning">‚ö†Ô∏è Atualiza refer√™ncia</span>
            </label>
            <select id="idContratante"></select>
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Cerimonialista</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="idCerimonialista">
              <option value="">-- Sem cerimonialista --</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="label-indicator">
            <span>Local do Evento</span>
            <span class="indicator indicator-warning">‚ö†Ô∏è Atualiza refer√™ncia</span>
          </label>
          <select id="idEndereco"></select>
        </div>
      </div>
      
      <!-- DADOS FINANCEIROS -->
      <div class="section">
        <div class="section-title">üí∞ Dados Financeiros</div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Valor Total (R$)</span>
              <span class="indicator indicator-critical">üî¥ Cr√≠tico</span>
            </label>
            <input type="number" id="valorTotal" step="0.01" min="0">
            <p class="helper-text">‚ö†Ô∏è Recalcula comiss√µes se houver pendentes</p>
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Vendedor</span>
              <span class="indicator indicator-critical">üî¥ Cr√≠tico</span>
            </label>
            <select id="idVendedor"></select>
            <p class="helper-text">‚ö†Ô∏è Pode transferir comiss√µes pendentes</p>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Valor BV (R$)</span>
              <span class="indicator indicator-critical">üî¥ Cr√≠tico</span>
            </label>
            <input type="number" id="valorBV" step="0.01" min="0">
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Parceiro BV</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="idBV">
              <option value="">-- Sem BV --</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Valor NF (R$)</span>
              <span class="indicator indicator-critical">üî¥ Cr√≠tico</span>
            </label>
            <input type="number" id="valorNF" step="0.01" min="0">
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Tem NF?</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <select id="temNF">
              <option value="N√ÉO">N√£o</option>
              <option value="SIM">Sim</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- DETALHES OPERACIONAIS -->
      <div class="section">
        <div class="section-title">üé≠ Detalhes Operacionais</div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label-indicator">
              <span>Look/Figurino</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <input type="text" id="look" placeholder="Ex: Terno">
          </div>
          
          <div class="form-group">
            <label class="label-indicator">
              <span>Respons√°vel Som</span>
              <span class="indicator indicator-free">üü¢ Livre</span>
            </label>
            <input type="text" id="somResponsavel" placeholder="Nome do m√∫sico">
          </div>
        </div>
        
        <div class="form-group">
          <label class="label-indicator">
            <span>Observa√ß√µes</span>
            <span class="indicator indicator-free">üü¢ Livre</span>
          </label>
          <textarea id="observacoes" placeholder="Anota√ß√µes gerais sobre o evento..."></textarea>
        </div>
      </div>
      
      <!-- A√á√ïES -->
      <div class="actions">
        <button class="btn btn-secondary" onclick="voltarParaBusca()">‚Ü©Ô∏è Voltar para Busca</button>
        <button class="btn btn-primary" onclick="validarEMostrarResumo()">
          üíæ Salvar Altera√ß√µes
        </button>
      </div>
    </div>
  </div>
  
  <!-- MODAL DE CONFIRMA√á√ÉO -->
  <div id="modalConfirmacao" class="modal-overlay">
    <div class="modal">
      <div class="modal-title">
        ‚ö†Ô∏è Confirmar Altera√ß√µes
      </div>
      
      <p style="margin-bottom: 20px; color: #666;">
        As seguintes altera√ß√µes ser√£o realizadas no evento:
      </p>
      
      <ul id="listaAlteracoes" class="changes-list"></ul>
      
      <div id="resumoValidacoes" class="validation-summary"></div>
      
      <div class="actions">
        <button class="btn btn-secondary" onclick="fecharModal()">‚Ü©Ô∏è Voltar</button>
        <button class="btn btn-primary" onclick="confirmarEdicao()">‚úÖ Confirmar Altera√ß√µes</button>
      </div>
    </div>
  </div>
  
  <script>
let eventoAtual = null;
let eventoOriginal = null;
let contratantesCache = [];
let permissaoFinanceira = null;

function bloquearEdicaoFinanceira(motivo) {
  const campos = [
    'valorTotal',
    'valorBV',
    'valorNF',
    'idBV',
    'idVendedor'
  ];

  campos.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.disabled = true;
    el.classList.add('campo-bloqueado');
  });

  if (document.getElementById('avisoFinanceiroBloqueado')) return;

  const aviso = document.createElement('div');
  aviso.id = 'avisoFinanceiroBloqueado';
  aviso.className = 'alert alert-warning';
  aviso.innerHTML = `
    üîí <strong>Edi√ß√£o financeira bloqueada</strong><br>
    ${motivo || 'Este evento j√° possui movimenta√ß√£o financeira registrada.'}
  `;

  const statusFinanceiro = document.getElementById('statusFinanceiro');
  if (statusFinanceiro) {
    statusFinanceiro.prepend(aviso);
  }
}

// ============================
// BLOCO 2 ‚Äî DATAS E CONFLITOS
// ============================

// Converte Date / string da planilha para input[type=date]
function normalizarDataParaInput(data) {
  if (!data) return '';
  if (data instanceof Date) {
    const y = data.getFullYear();
    const m = String(data.getMonth() + 1).padStart(2, '0');
    const d = String(data.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }
  if (typeof data === 'string') {
    // yyyy-mm-dd (j√° ok)
    if (/^\d{4}-\d{2}-\d{2}$/.test(data)) return data;
    // dd/mm/yyyy
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(data)) {
      const [d, m, y] = data.split('/');
      return `${y}-${m}-${d}`;
    }
  }
  return '';
}

function toggleDataFimEdicao() {
  const chk = document.getElementById('eventoMultiDias');
  const grupo = document.getElementById('grupoDataFim');
  if (!chk || !grupo) return;

  grupo.classList.toggle('hidden', !chk.checked);

  if (!chk.checked) {
    document.getElementById('dataFim').value = '';
  }

  verificarConflitosEdicao();
}


let verificadorExecucaoId = 0;

function verificarConflitosEdicao() {
  if (!eventoOriginal) return;

  const dataInicio = document.getElementById('dataEvento')?.value;
  if (!dataInicio) {
    renderizarConflitosEdicao([]);
    return;
  }

  const multiDias = document.getElementById('eventoMultiDias')?.checked;
  const dataFimCampo = document.getElementById('dataFim');
  const dataFim = multiDias && dataFimCampo?.value ? dataFimCampo.value : dataInicio;

  verificadorExecucaoId++;
  const execucaoAtual = verificadorExecucaoId;

  function gerarIntervaloDatas(inicio, fim) {
    const datas = [];
    let atual = new Date(inicio + 'T12:00:00');
    const final = new Date(fim + 'T12:00:00');

    while (atual <= final) {
      datas.push(atual.toISOString().slice(0, 10));
      atual.setDate(atual.getDate() + 1);
    }
    return datas;
  }

  const datasParaVerificar = gerarIntervaloDatas(dataInicio, dataFim);

  let conflitos = [];
  let concluidas = 0;

  datasParaVerificar.forEach(data => {
    google.script.run
      .withSuccessHandler(eventos => {
        if (execucaoAtual !== verificadorExecucaoId) return;

        if (Array.isArray(eventos)) {
          eventos.forEach(ev => {
            if (String(ev.id) !== String(eventoOriginal.id)) {
              const chave = ev.id + '|' + ev.data + '|' + (ev.dataFim || '');
              if (!conflitos.some(c => c.__chave === chave)) {
                conflitos.push({ ...ev, __chave: chave });
              }
            }
          });
        }

        concluidas++;
        if (concluidas === datasParaVerificar.length) {
          renderizarConflitosEdicao(conflitos);
        }
      })
      .buscarEventosPorData(data);
  });
}

function renderizarConflitosEdicao(eventos) {
  const container = document.getElementById('statusAgenda');
  if (!container) return;

  if (!eventos || eventos.length === 0) {
    container.innerHTML =
      '<div class="status-box safe">üü¢ Nenhum conflito de agenda detectado</div>';
    return;
  }

  let html = `
    <div class="status-box danger">
      <strong>‚ö†Ô∏è Conflitos de agenda detectados:</strong>
      <ul style="margin-top:8px;">
  `;

  eventos.forEach(ev => {
    html += `
      <li>
        ${ev.tipoRegistro || 'Evento'} ‚Äî
        ${ev.data}${ev.dataFim ? ' at√© ' + ev.dataFim : ''}
        ${ev.nomeLocal ? 'üìç ' + ev.nomeLocal : ''}
      </li>
    `;
  });

  html += '</ul></div>';
  container.innerHTML = html;
}

function setValueSafe(id, valor, tentativas = 0) {
  const el = document.getElementById(id);
  if (!el) return;

  const val = String(valor ?? '').trim();

  const existe = Array.from(el.options).some(o => o.value === val);
  if (existe) {
    el.value = val;
    return;
  }

  if (tentativas < 20) {
    setTimeout(() => setValueSafe(id, valor, tentativas + 1), 100);
  }
}
    
    window.onload = function() {
      fecharModal();
      carregarDropdowns();
      carregarContratantesParaAutocomplete();
    };
    
    // TOGGLE DE TIPO DE BUSCA
    function trocarTipoBusca(tipo) {
      // Remove active de todos os grupos
      document.querySelectorAll('.search-field-group').forEach(g => g.classList.remove('active'));
      document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
      
      // Ativa o selecionado
      document.getElementById('searchBy' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).classList.add('active');
      event.target.closest('.toggle-btn').classList.add('active');
      
      // Limpa resultados
      document.getElementById('resultsSection').classList.remove('show');
    }
    
    // BUSCAR EVENTO (dispatcher)
    function buscarEvento() {
      const tipo = document.querySelector('input[name="searchType"]:checked').value;
      
      switch(tipo) {
        case 'id':
          buscarPorID();
          break;
        case 'nome':
          buscarPorNome();
          break;
        case 'data':
          buscarPorData();
          break;
        case 'periodo':
          buscarPorPeriodo();
          break;
      }
    }
    
    // BUSCA POR ID
    function buscarPorID() {
      const id = document.getElementById('inputID').value.trim();
      console.log('üîç buscarPorID: ID =', id);
      
      if (!id) {
        mostrarAlerta('Digite um ID para buscar', 'error');
        return;
      }
      
      mostrarLoading();
      console.log('‚è≥ Chamando buscarEventoPorID no backend...');
      
      google.script.run
        .withSuccessHandler(function(resultado) {
          console.log('‚úÖ Backend retornou:', resultado);
          mostrarResultados(resultado);
        })
        .withFailureHandler(function(erro) {
          console.error('‚ùå Erro:', erro);
          mostrarAlerta('Erro: ' + erro.message, 'error');
        })
        .buscarEventoPorID(id);
    }
    
    // BUSCA POR NOME
    function buscarPorNome() {
      const nome = document.getElementById('inputNome').value.trim();
      console.log('üîç buscarPorNome: Nome =', nome);
      
      if (!nome) {
        mostrarAlerta('Digite um nome para buscar', 'error');
        return;
      }
      
      mostrarLoading();
      console.log('‚è≥ Chamando buscarEventoPorContratante no backend...');
      
      google.script.run
        .withSuccessHandler(function(resultado) {
          console.log('‚úÖ Backend retornou:', resultado);
          mostrarResultados(resultado);
        })
        .withFailureHandler(function(erro) {
          console.error('‚ùå Erro:', erro);
          mostrarAlerta('Erro: ' + erro.message, 'error');
        })
        .buscarEventoPorContratante(nome);
    }
    
    // BUSCA POR DATA
    function buscarPorData() {
      const data = document.getElementById('inputData').value;
      console.log('üîç buscarPorData: Data =', data);
      
      if (!data) {
        mostrarAlerta('Selecione uma data', 'error');
        return;
      }
      
      mostrarLoading();
      console.log('‚è≥ Chamando buscarEventoPorData no backend...');
      
      google.script.run
        .withSuccessHandler(function(resultado) {
          console.log('‚úÖ Backend retornou:', resultado);
          mostrarResultados(resultado);
        })
        .withFailureHandler(function(erro) {
          console.error('‚ùå Erro:', erro);
          mostrarAlerta('Erro: ' + erro.message, 'error');
        })
        .buscarEventoPorData(data);
    }
    
    // BUSCA POR PER√çODO
    function buscarPorPeriodo() {
      const periodo = document.getElementById('inputPeriodo').value;
      console.log('üîç buscarPorPeriodo: Per√≠odo =', periodo);
      
      if (!periodo) {
        mostrarAlerta('Selecione um per√≠odo', 'error');
        return;
      }
      
      mostrarLoading();
      console.log('‚è≥ Chamando buscarEventoPorPeriodo no backend...');
      
      google.script.run
        .withSuccessHandler(function(resultado) {
          console.log('‚úÖ Backend retornou:', resultado);
          mostrarResultados(resultado);
        })
        .withFailureHandler(function(erro) {
          console.error('‚ùå Erro:', erro);
          mostrarAlerta('Erro: ' + erro.message, 'error');
        })
        .buscarEventoPorPeriodo(periodo);
    }
    
    // AUTOCOMPLETE
    function carregarContratantesParaAutocomplete() {
      google.script.run
        .withSuccessHandler(lista => { contratantesCache = lista; })
        .listarContratantes();
    }
    
    function autocompleteContratante(termo) {
      const list = document.getElementById('autocompleteList');
      
      if (!termo || termo.length < 2) {
        list.classList.remove('show');
        return;
      }
      
      const matches = contratantesCache.filter(c => 
        c.nome.toLowerCase().includes(termo.toLowerCase())
      ).slice(0, 10);
      
      if (matches.length === 0) {
        list.classList.remove('show');
        return;
      }
      
      list.innerHTML = '';
      matches.forEach(c => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.textContent = c.nome;
        item.onclick = () => {
          document.getElementById('inputNome').value = c.nome;
          list.classList.remove('show');
        };
        list.appendChild(item);
      });
      
      list.classList.add('show');
    }
    
    // Fecha autocomplete ao clicar fora
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.autocomplete-wrapper')) {
        document.getElementById('autocompleteList').classList.remove('show');
      }
    });
    
    // MOSTRAR LOADING
    function mostrarLoading() {
      const section = document.getElementById('resultsSection');
      section.classList.add('show');
      document.getElementById('resultsList').innerHTML = '<div class="loading"><div class="spinner"></div>Buscando eventos...</div>';
    }
    
    // MOSTRAR RESULTADOS
    function mostrarResultados(eventos) {
  const section = document.getElementById('resultsSection');
  const list = document.getElementById('resultsList');
  const count = document.getElementById('resultsCount');

  section.classList.add('show');

  // ‚úÖ CORRE√á√ÉO 1 ‚Äî backend inv√°lido
  if (!Array.isArray(eventos)) {
    list.innerHTML = '<div class="empty-state">Erro ao buscar eventos.</div>';
    count.textContent = '';
    return;
  }

  // ‚úÖ CORRE√á√ÉO 2 ‚Äî retorno vazio expl√≠cito
  if (eventos.length === 0) {
    list.innerHTML = '<div class="empty-state">Nenhum evento encontrado para esse filtro.</div>';
    count.textContent = '0 resultados';
    return;
  }

  // fluxo normal (mant√©m seu layout)
  count.textContent = `${eventos.length} evento(s) encontrado(s)`;
  list.innerHTML = '';

  eventos.forEach(evento => {
    const card = document.createElement('div');
    card.className = 'result-card';

    card.innerHTML = `
      <div class="result-id">${evento.id}</div>

      <div class="result-main">
        ${evento.tipoEvento} ‚Äî ${evento.contratante}
      </div>

      <div class="result-details">
        <div class="result-detail">üìÖ ${evento.dataFormatada}</div>
        <div class="result-detail">
          üí∞ R$ ${Number(evento.valor || 0).toLocaleString('pt-BR', {
            minimumFractionDigits: 2
          })}
        </div>
      </div>

      <div class="result-actions">
        <button
          class="btn-card btn-edit"
          onclick="selecionarEvento('${evento.id}')">
          ‚úèÔ∏è Editar Evento
        </button>
      </div>
    `;

    list.appendChild(card);
  });
}
    
    // SELECIONAR EVENTO PARA EDI√á√ÉO
  function selecionarEvento(idEvento) {
  console.log('1Ô∏è‚É£ clicar editar', idEvento);
  mostrarAlerta('Carregando evento...', 'info');

  google.script.run
    .withSuccessHandler(function(resultado) {
      console.log('2Ô∏è‚É£ retorno backend', resultado);

      if (!resultado || !resultado.sucesso) {
        console.log('‚ùå resultado inv√°lido');
        mostrarAlerta(resultado?.mensagem || 'Erro desconhecido', 'error');
        return;
      }

      console.log('3Ô∏è‚É£ sucesso true');

      eventoAtual = resultado.evento;
      eventoOriginal = JSON.parse(JSON.stringify(resultado.evento));

      console.log('4Ô∏è‚É£ eventoAtual setado');

      setTimeout(() => {
        console.log('5Ô∏è‚É£ timeout entrou');

        preencherFormulario(eventoAtual);
        console.log('6Ô∏è‚É£ formul√°rio preenchido');

        mostrarStatusFinanceiro(resultado.statusFinanceiro);
        // --- Permiss√£o financeira (Fase 3 ‚Äì A) ---
        google.script.run
          .withSuccessHandler(function(permissao) {
            permissaoFinanceira = permissao;

            if (!permissao.permitido) {
              bloquearEdicaoFinanceira(permissao.motivo);
            }
          })
          .verificarPermissaoEdicaoFinanceira(eventoAtual.id);
        // --- Fim permiss√£o financeira ---
        console.log('7Ô∏è‚É£ status financeiro ok');

        document.querySelector('.search-section').style.display = 'none';
        console.log('8Ô∏è‚É£ busca escondida');

        document.getElementById('formEdicao').classList.remove('hidden');
    // ===============================
// BLOCO 2 ‚Äî ATIVAR CONFLITOS AP√ìS LOAD
// ===============================
setTimeout(() => {
  ['dataEvento', 'dataFim', 'horaInicio', 'duracao'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.removeEventListener('change', verificarConflitosEdicao);
      el.addEventListener('change', verificarConflitosEdicao);
    }
  });

  // Primeira verifica√ß√£o autom√°tica
  verificarConflitosEdicao();
}, 300);
        console.log('9Ô∏è‚É£ formul√°rio exibido');

        mostrarAlerta('Evento carregado! Fa√ßa as altera√ß√µes desejadas.', 'success');
      }, 150);
    })
    .withFailureHandler(function(erro) {
      console.error('üî• erro backend', erro);
      mostrarAlerta('Erro: ' + erro.message, 'error');
    })
    .buscarEventoParaEdicao(idEvento);
}
// --- Valida√ß√£o de impacto financeiro antes de salvar ---
function validarImpactoFinanceiroAntesSalvar(callback) {
  google.script.run
    .withSuccessHandler(function(resultado) {
      if (resultado?.risco === 'EXCESSO_GERADO') {
        mostrarAlerta(
          '‚ùå Altera√ß√£o bloqueada: j√° existe comiss√£o gerada maior que a nova comiss√£o calculada.',
          'error'
        );
        return;
      }
      callback();
    })
    .withFailureHandler(function(err) {
      mostrarAlerta('Erro ao validar impacto financeiro: ' + err.message, 'error');
    })
    .validarAlteracoesEvento(eventoOriginal.id, coletarDadosFormulario());
}
    
    // Resto das fun√ß√µes (igual √† vers√£o anterior)
    function carregarDropdowns() {
      google.script.run.withSuccessHandler(lista => popularDropdown('idContratante', lista)).listarContratantes();
      google.script.run.withSuccessHandler(lista => popularDropdown('idCerimonialista', lista, true)).listarCerimonialistas();
      google.script.run.withSuccessHandler(lista => popularDropdown('idEndereco', lista)).listarEnderecos();
      google.script.run.withSuccessHandler(lista => popularDropdown('idVendedor', lista)).listarVendedores();
      google.script.run.withSuccessHandler(lista => popularDropdown('idBV', lista, true)).listarParceirosBV();
      
      // CONFIG - Tipo de Evento
      google.script.run.withSuccessHandler(function(tipos) {
        const sel = document.getElementById('tipoEvento');
        if (!sel) return;
        const valorAtual = sel.value;
        sel.innerHTML = '<option value="">Selecione...</option>';
        tipos.forEach(function(tipo) {
          const opt = document.createElement('option');
          opt.value = tipo;
          opt.textContent = tipo;
          sel.appendChild(opt);
        });
        if (valorAtual) sel.value = valorAtual;
      }).listarTiposEvento();
      
      // CONFIG - Dura√ß√µes
      google.script.run.withSuccessHandler(function(duracoes) {
        const sel = document.getElementById('duracao');
        if (!sel) return;
        const valorAtual = sel.value;
        sel.innerHTML = '<option value="">Selecione...</option>';
        duracoes.forEach(function(dur) {
          const opt = document.createElement('option');
          opt.value = dur;
          opt.textContent = dur;
          sel.appendChild(opt);
        });
        if (valorAtual) sel.value = valorAtual;
      }).listarDuracoesPadrao();
      
      // CONFIG - Projetos
      google.script.run.withSuccessHandler(function(projetos) {
        const sel = document.getElementById('projeto');
        if (!sel) return;
        const valorAtual = sel.value;
        sel.innerHTML = '<option value="">Selecione...</option>';
        projetos.forEach(function(proj) {
          const opt = document.createElement('option');
          const v = String(proj).trim();
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
        if (valorAtual) sel.value = valorAtual;
      }).listarProjetosSugeridos();
    }
    
    function popularDropdown(id, lista, opcional = false) {
      const select = document.getElementById(id);
      if (!opcional) select.innerHTML = '';
      lista.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.nome;
        select.appendChild(option);
      });
    }
    
    function preencherFormulario(evento) {
  // Campos de data e hora
  document.getElementById('dataEvento').value = evento.dataEvento || '';
  document.getElementById('horaInicio').value = evento.horaInicio || '';

  // DATA_FIM multi-dias
  if (evento.dataFim) {
    document.getElementById('eventoMultiDias').checked = true;
    document.getElementById('grupoDataFim').classList.remove('hidden');
    document.getElementById('dataFim').value =
  evento.dataFim || '';
  } else {
    document.getElementById('eventoMultiDias').checked = false;
    document.getElementById('grupoDataFim').classList.add('hidden');
    document.getElementById('dataFim').value = '';
  }

  // SELECTS ‚Äî usar setValueSafe para todos os selects que s√£o populados assincronamente
  setValueSafe('idContratante', evento.idContratante);
  setValueSafe('idCerimonialista', evento.idCerimonialista);
  setValueSafe('idEndereco', evento.idEndereco);
  setValueSafe('idVendedor', evento.idVendedor);
  setValueSafe('idBV', evento.idBV);
  setValueSafe('tipoEvento', evento.tipoEvento);
  setValueSafe('duracao', evento.duracao);
  setValueSafe('projeto', evento.projeto);
  setValueSafe('temNF', evento.temNF || 'N√ÉO');

  // Campos simples
  document.getElementById('valorTotal').value = evento.valorTotal || 0;
  document.getElementById('valorBV').value = evento.valorBV || 0;
  document.getElementById('valorNF').value = evento.valorNF || 0;
  document.getElementById('look').value = evento.look || '';
  document.getElementById('somResponsavel').value = evento.somResponsavel || '';
  document.getElementById('observacoes').value = evento.observacoes || '';
  
  // Calcular hor√°rio fim ap√≥s carregar os dados
  setTimeout(calcularHorarioFim, 500);
}
    
   function mostrarStatusFinanceiro(status) {
  const container = document.getElementById('statusFinanceiro');
  if (!container) return;

  let classe = 'safe';
  let icone = '‚ÑπÔ∏è';
  let mensagem = status?.mensagem || 'Status financeiro n√£o informado';

  if (status?.tipo === 'bloqueado') {
    classe = 'danger';
    icone = 'üîí';
    mensagem = 'Altera√ß√µes financeiras bloqueadas. Este evento j√° possui recebimentos ou comiss√µes geradas.';
  } else if (status?.tipo === 'atencao') {
    classe = 'warning';
    icone = '‚ö†Ô∏è';
  }

  container.innerHTML = `
    <div class="status-box ${classe}">
      <span class="status-icon">${icone}</span>
      <div><strong>Status Financeiro:</strong> ${mensagem}</div>
    </div>
  `;
}
    
    function validarEMostrarResumo() {
      if (!eventoOriginal || !eventoAtual) {
        mostrarAlerta('‚ùå Nenhum evento selecionado!', 'error');
        return;
      }
      
      const alteracoes = detectarAlteracoes();
      
      if (alteracoes.length === 0) {
        mostrarAlerta('‚ÑπÔ∏è Nenhuma altera√ß√£o detectada', 'info');
        return;
      }
      
      const lista = document.getElementById('listaAlteracoes');
      lista.innerHTML = '';
      
      alteracoes.forEach(alt => {
        const li = document.createElement('li');
        li.className = 'change-item';
        let html = `
          <div class="change-field">${alt.campo}</div>
          <div class="change-values">
            <span class="change-old">${alt.valorAntigo}</span> ‚Üí 
            <span class="change-new">${alt.valorNovo}</span>
          </div>
        `;
        if (alt.impacto) html += `<div class="change-impact">üí° ${alt.impacto}</div>`;
        li.innerHTML = html;
        lista.appendChild(li);
      });
      
      google.script.run
        .withSuccessHandler(resultado => {
          mostrarResumoValidacoes(resultado);
          abrirModal();
        })
        .withFailureHandler(erro => mostrarAlerta('Erro: ' + erro.message, 'error'))
        .validarAlteracoesEvento(eventoOriginal.id, coletarDadosFormulario());
    }
    
    function detectarAlteracoes() {
      const alteracoes = [];
      const dados = coletarDadosFormulario();
      const campos = {
        dataEvento: 'Data do Evento', horaInicio: 'Hora de In√≠cio',
        duracao: 'Dura√ß√£o', tipoEvento: 'Tipo de Evento', projeto: 'Formato/Projeto',
        idContratante: 'Contratante', idCerimonialista: 'Cerimonialista', idEndereco: 'Local',
        valorTotal: 'Valor Total', idVendedor: 'Vendedor', valorBV: 'Valor BV',
        idBV: 'Parceiro BV', valorNF: 'Valor NF', temNF: 'Tem NF',
        look: 'Look', somResponsavel: 'Respons√°vel Som', observacoes: 'Observa√ß√µes'
      };
      const impactos = {
        valorTotal: 'Comiss√µes pendentes ser√£o recalculadas',
        valorBV: 'Base de comiss√£o ser√° recalculada',
        valorNF: 'Base de comiss√£o ser√° recalculada',
        idVendedor: 'Pode transferir comiss√µes pendentes',
        dataEvento: 'Verificar conflitos na agenda',
        horaInicio: 'Verificar conflitos na agenda'
      };
      
      for (let campo in campos) {
        const valorAntigo = String(eventoOriginal[campo] || '');
        const valorNovo = String(dados[campo] || '');
        if (valorAntigo !== valorNovo) {
          alteracoes.push({
            campo: campos[campo],
            valorAntigo: valorAntigo || '(vazio)',
            valorNovo: valorNovo || '(vazio)',
            impacto: impactos[campo] || null
          });
        }
      }
      return alteracoes;
    }
    
    function mostrarResumoValidacoes(resultado) {
      const resumo = document.getElementById('resumoValidacoes');
      let html = '';
      if (resultado.avisos?.length) resultado.avisos.forEach(a => html += `<div class="validation-item">‚ö†Ô∏è ${a}</div>`);
      if (resultado.conflitos?.length) resultado.conflitos.forEach(c => html += `<div class="validation-item" style="color: #dc3545;">üî¥ ${c}</div>`);
      if (!resultado.avisos?.length && !resultado.conflitos?.length) html = '<div class="validation-item">‚úÖ Sem conflitos detectados</div>';
      resumo.innerHTML = html;
    }
    
    function coletarDadosFormulario() {
      return {
        dataEvento: document.getElementById('dataEvento').value,
        horaInicio: document.getElementById('horaInicio').value,
        duracao: document.getElementById('duracao').value,
        tipoEvento: document.getElementById('tipoEvento').value,
        projeto: document.getElementById('projeto').value,
        idContratante: document.getElementById('idContratante').value,
        idCerimonialista: document.getElementById('idCerimonialista').value,
        idEndereco: document.getElementById('idEndereco').value,
        valorTotal: parseFloat(document.getElementById('valorTotal').value) || 0,
        idVendedor: document.getElementById('idVendedor').value,
        valorBV: parseFloat(document.getElementById('valorBV').value) || 0,
        idBV: document.getElementById('idBV').value,
        valorNF: parseFloat(document.getElementById('valorNF').value) || 0,
        temNF: document.getElementById('temNF').value === 'SIM',
        look: document.getElementById('look').value,
        somResponsavel: document.getElementById('somResponsavel').value,
        observacoes: document.getElementById('observacoes').value
      };
    }
    
    function confirmarEdicao() {
      fecharModal();
      mostrarAlerta('Validando impacto financeiro...', 'info');

      validarImpactoFinanceiroAntesSalvar(function() {
        mostrarAlerta('Salvando altera√ß√µes...', 'info');

        google.script.run
          .withSuccessHandler(resultado => {
            if (resultado.sucesso) {
              mostrarAlerta('‚úÖ ' + resultado.mensagem, 'success');
              setTimeout(() => google.script.host.close(), 2000);
            } else {
              mostrarAlerta('‚ùå ' + resultado.mensagem, 'error');
            }
          })
          .withFailureHandler(erro => mostrarAlerta('Erro: ' + erro.message, 'error'))
          .salvarEdicaoEvento(eventoOriginal.id, coletarDadosFormulario());
      });
    }
    
    function abrirModal() {
      document.getElementById('modalConfirmacao').classList.add('show');
    }
    
    function fecharModal() {
      document.getElementById('modalConfirmacao').classList.remove('show');
    }
    
    function mostrarAlerta(mensagem, tipo) {
      const container = document.getElementById('alertContainer');
      const classe = tipo === 'success' ? 'alert-success' : tipo === 'error' ? 'alert-error' : 'alert-info';
      container.innerHTML = `<div class="alert ${classe}">${mensagem}</div>`;
      if (tipo === 'success' || tipo === 'info') {
        setTimeout(() => container.innerHTML = '', 5000);
      }
    }
    
    // ========================================
    // CALCULAR HOR√ÅRIO FIM
    // ========================================
    function calcularHorarioFim() {
      const inputHora = document.getElementById('horaInicio');
      const inputDuracao = document.getElementById('duracao');
      const display = document.getElementById('horarioFimCalc');
      
      if (!inputHora || !inputDuracao || !display) return;
      
      const horaInicio = inputHora.value;
      const duracao = inputDuracao.value;
      
      if (!horaInicio || !duracao) {
        display.style.display = 'none';
        return;
      }
      
      // Converter dura√ß√£o para minutos (formato: 2h, 2h30, etc)
      const match = duracao.match(/(\d+)h(?:(\d+))?/);
      if (!match) {
        display.style.display = 'none';
        return;
      }
      
      const horas = parseInt(match[1]) || 0;
      const minutos = parseInt(match[2]) || 0;
      const totalMinutos = (horas * 60) + minutos;
      
      // Calcular hor√°rio fim
      const partes = horaInicio.split(':');
      const h = parseInt(partes[0]);
      const m = parseInt(partes[1]);
      
      const inicio = new Date();
      inicio.setHours(h, m, 0);
      
      const fim = new Date(inicio.getTime() + totalMinutos * 60000);
      const horaFim = String(fim.getHours()).padStart(2, '0');
      const minFim = String(fim.getMinutes()).padStart(2, '0');
      
      display.textContent = '‚è∞ T√©rmino previsto: ' + horaFim + ':' + minFim;
      display.style.display = 'block';
    }
    
    // ========================================
    // CORRIGIR BOT√ÉO VOLTAR
    // ========================================
    window.voltarParaBusca = function() {
      if (confirm('Descartar altera√ß√µes e voltar para a busca?')) {
        document.querySelector('.search-section').style.display = 'block';
        document.getElementById('formEdicao').classList.add('hidden');
        eventoAtual = null;
        eventoOriginal = null;
      }
    };
    
    // ========================================
    // EVENT LISTENERS PARA HOR√ÅRIO FIM
    // ========================================
    setTimeout(function() {
      const inputHora = document.getElementById('horaInicio');
      const inputDuracao = document.getElementById('duracao');
      
      if (inputHora) {
        inputHora.addEventListener('change', calcularHorarioFim);
      }
      if (inputDuracao) {
        inputDuracao.addEventListener('change', calcularHorarioFim);
      }
    }, 1000);

    // ========================================
    // BLOCO 2 ‚Äî DATAS/CONFLITOS: EVENT LISTENERS
    // ========================================
  
  </script>
</body>
</html>

