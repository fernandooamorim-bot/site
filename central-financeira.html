<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f1a2e"/>

  <!-- Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Auth padr√£o do sistema -->
  <script src="auth.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    /* ============================================
       GLOBAL NAV ‚Äî FA PRODU√á√ïES Design System
       ============================================ */
    :root {
      --nav-navy-900: #0a1628;
      --nav-navy-800: #0f1a2e;
      --nav-navy-700: #142240;
      --nav-navy-600: #1e3a5f;
      --nav-gold-500: #d4a853;
      --nav-gold-400: #e0bc6a;
      --nav-font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --nav-height: 68px;
      --nav-radius-md: 12px;
      --nav-radius-sm: 8px;
      --nav-radius-full: 999px;
    }

    .global-header {
      background: var(--nav-navy-800);
      color: white;
      padding: 0 20px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      position: sticky;
      top: 0;
      z-index: 200;
      font-family: var(--nav-font);
    }

    .global-header-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .global-header-brand:hover { opacity: 0.85; }

    .global-header-back {
      width: 32px;
      height: 32px;
      border-radius: var(--nav-radius-sm);
      background: rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
    }

    .global-header-brand:hover .global-header-back {
      background: rgba(212,168,83,0.15);
    }

    .global-header-back i { color: var(--nav-gold-400); width: 18px; height: 18px; }

    .global-header-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .global-header-title i { width: 20px; height: 20px; color: var(--nav-gold-400); }

    .global-header-user {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px 4px 4px;
      background: rgba(255,255,255,0.06);
      border-radius: var(--nav-radius-full);
      border: 1px solid rgba(255,255,255,0.08);
      font-family: var(--nav-font);
    }

    .global-header-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--nav-navy-600), rgba(58,96,152,0.8));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: var(--nav-gold-400);
      text-transform: uppercase;
    }

    .global-header-name {
      color: rgba(255,255,255,0.7);
      font-size: 12px;
      font-weight: 600;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height);
      background: var(--nav-navy-800);
      border-top: 1px solid rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: space-around;
      z-index: 200;
      padding-bottom: env(safe-area-inset-bottom);
      font-family: var(--nav-font);
    }

    .bnav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      padding: 8px 14px;
      border-radius: var(--nav-radius-md);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      text-decoration: none;
      border: none;
      background: none;
      transition: all 0.2s;
    }

    .bnav-item i { width: 22px; height: 22px; color: rgba(255,255,255,0.55); transition: color 0.2s; }
    .bnav-item span { font-family: var(--nav-font); font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.55); transition: color 0.2s; }
    .bnav-item.active i, .bnav-item:hover i { color: var(--nav-gold-400); }
    .bnav-item.active span, .bnav-item:hover span { color: var(--nav-gold-400); }
    .bnav-item.active { background: rgba(212,168,83,0.08); }

    @media (min-width: 768px) {
      .bottom-nav { display: none; }
      body { padding-bottom: 0 !important; }
    }

    @media (max-width: 767px) {
      body { padding-bottom: calc(var(--nav-height) + 16px) !important; }
    }
  </style>

  <style>
    /* ============================================
       DESIGN SYSTEM ‚Äî FA PRODU√á√ïES (central-financeira)
       ============================================ */
    :root {
      --navy-900: #0a1628;
      --navy-800: #0f1a2e;
      --navy-700: #142240;
      --navy-600: #1e3a5f;
      --navy-500: #264a7a;
      --navy-400: #3a6098;
      --gold-600: #b8903e;
      --gold-500: #d4a853;
      --gold-400: #e0bc6a;
      --gold-300: #ebd08c;
      --gray-50: #f8f9fc;
      --gray-100: #f1f3f8;
      --gray-200: #e2e6ef;
      --gray-300: #cdd3e0;
      --gray-400: #9ca3b8;
      --gray-500: #6b7490;
      --gray-600: #4a5268;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #3b82f6;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 3px rgba(10,22,40,0.06);
      --shadow-md: 0 4px 16px rgba(10,22,40,0.08);
      --shadow-lg: 0 8px 32px rgba(10,22,40,0.14);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font);
      background: var(--gray-50);
      color: var(--gray-800);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ============================================
       CONTAINER
       ============================================ */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 20px 32px;
    }

    @media (min-width: 768px) {
      .container { padding: 32px; }
    }

    .container > h1 {
      display: none;
    }

    /* ============================================
       LOADING OVERLAY
       ============================================ */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(10,22,40,0.7);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      gap: 14px;
      color: rgba(255,255,255,0.7);
      font-family: var(--font);
      font-size: 14px;
      font-weight: 500;
    }

    .loading-overlay.active { display: flex; }

    .loading-spinner {
      width: 44px;
      height: 44px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top: 3px solid var(--gold-500);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ============================================
       INTENT BUTTONS (operation selector)
       ============================================ */
    .intent {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .intent button {
      flex: 1;
      min-width: 130px;
      padding: 14px 16px;
      border-radius: var(--radius-md);
      border: 1.5px solid var(--gray-200);
      background: white;
      color: var(--gray-600);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font);
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }

    .intent button:hover {
      border-color: var(--navy-400);
      color: var(--navy-600);
      background: rgba(30,58,95,0.03);
    }

    .intent button.active {
      border-color: var(--navy-600);
      background: var(--navy-600);
      color: white;
      box-shadow: 0 2px 8px rgba(30,58,95,0.2);
    }

    /* ============================================
       MAIN LAYOUT (form + side)
       ============================================ */
    .main {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .box {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px 20px;
      flex: 1;
      min-width: 280px;
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }

    .box h3 {
      font-size: 16px;
      font-weight: 700;
      color: var(--navy-600);
      margin-bottom: 4px;
      letter-spacing: -0.2px;
    }

    .box h4 {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 4px;
    }

    .side {
      width: 360px;
      max-width: 100%;
    }

    /* ============================================
       FORM ELEMENTS
       ============================================ */
    label {
      display: block;
      margin-top: 14px;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      letter-spacing: -0.1px;
    }

    input, select, textarea {
      width: 100%;
      padding: 11px 14px;
      margin-top: 6px;
      border-radius: var(--radius-sm);
      border: 1.5px solid var(--gray-200);
      background: white;
      color: var(--gray-800);
      font-size: 14px;
      font-family: var(--font);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--navy-500);
      box-shadow: 0 0 0 3px rgba(30,58,95,0.08);
    }

    input::placeholder, textarea::placeholder {
      color: var(--gray-400);
    }

    input[readonly] {
      background: var(--gray-50);
      color: var(--gray-500);
    }

    textarea { resize: vertical; }

    /* ============================================
       ACTION BUTTONS
       ============================================ */
    .btn {
      margin-top: 16px;
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font);
      transition: all 0.2s;
      width: 100%;
      letter-spacing: -0.1px;
    }

    .primary {
      background: linear-gradient(135deg, var(--navy-600), var(--navy-700));
      color: white;
      box-shadow: 0 2px 8px rgba(30,58,95,0.2);
    }

    .primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(30,58,95,0.25);
    }

    .secondary {
      background: var(--navy-500);
      color: white;
      box-shadow: 0 2px 6px rgba(30,58,95,0.15);
    }

    .secondary:hover {
      background: var(--navy-400);
    }

    .danger {
      background: var(--danger-color);
      color: white;
      box-shadow: 0 2px 6px rgba(239,68,68,0.2);
    }

    .danger:hover {
      background: #dc2626;
    }

    /* ============================================
       AUTOCOMPLETE
       ============================================ */
    .autocomplete {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      margin-top: 0;
      overflow: hidden;
      box-shadow: 0 6px 16px rgba(10,22,40,0.1);
    }

    .autocomplete div {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 14px;
      color: var(--gray-700);
      border-bottom: 1px solid var(--gray-100);
      transition: background 0.15s;
    }

    .autocomplete div:hover {
      background: var(--gray-50);
    }

    .autocomplete div:last-child {
      border-bottom: none;
    }

    /* ============================================
       DIVIDER & MUTED
       ============================================ */
    .divider {
      margin: 16px 0;
      border: none;
      border-top: 1px solid var(--gray-200);
    }

    .muted {
      color: var(--gray-500);
      font-size: 13px;
      font-weight: 500;
      line-height: 1.5;
    }

    .muted strong {
      color: var(--gray-700);
    }
  </style>
</head>
<body>
  <!-- Global Header -->
  <div class="global-header">
    <a class="global-header-brand" onclick="window.location.href='index.html'" title="Voltar ao In√≠cio">
      <div class="global-header-back">
        <i data-lucide="arrow-left"></i>
      </div>
      <div class="global-header-title">
        <i data-lucide="dollar-sign"></i>
        <span>Central Financeira</span>
      </div>
    </a>
    <div class="global-header-user">
      <div class="global-header-avatar" id="ghAvatar">--</div>
      <div class="global-header-name" id="ghName"></div>
    </div>
  </div>

<div class="container">

<h1>üí∞ Central Financeira</h1>

<div class="intent">
  <button data-mode="recebimento">üü¢ Recebimento</button>
  <button data-mode="estorno">üî¥ Estorno</button>
  <button data-mode="comissao">üîµ Comiss√£o</button>
  <button data-mode="obrigacao">üü† Sa√≠das</button>
</div>

<div class="main">
  <div id="form" class="box"></div>

  <div id="side" class="box side">
    <h3>üìä Resumo</h3>
    <div id="resumo" class="muted">Selecione uma opera√ß√£o</div>
  </div>
</div>

<script>
console.log('üöÄ central-financeira.html iniciado (frontend externo)');

window.addEventListener('load', async () => {
  try {
    if (!window.Auth) throw new Error('AUTH_NOT_LOADED');

    const auth = await Auth.apiCall('verificarUsuario');
    if (!auth || !auth.ok) throw new Error('NOT_AUTH');

    console.log('üîê Usu√°rio autenticado:', auth.user?.email);

    iniciarCentralFinanceira();

  } catch (err) {
    console.error('Erro de autentica√ß√£o:', err);
    alert('Sess√£o expirada. Volte ao menu.');
    window.location.href = 'index.html';
  }
});

function showLoading(txt){
  document.getElementById('loadingText').innerText = txt || 'Processando...';
  document.getElementById('loading').classList.add('active');
}
function hideLoading(){
  document.getElementById('loading').classList.remove('active');
}

let mode = null;
let eventoSelecionado = null;
let vendedorSelecionado = null;
let vendedoresCache = [];
let comissoesPendentes = [];

let ultimoPreview = null;
let ultimoResumoFinanceiro = null;

const buttons = document.querySelectorAll('.intent button');
const form = document.getElementById('form');
const resumo = document.getElementById('resumo');

/* ================= INIT ================= */

// google.script.run.withSuccessHandler(list=>{
//  vendedoresCache = list || [];
// }).listarVendedores();

/* ================= MODE ================= */

buttons.forEach(b=>{
  b.onclick = ()=>{
    if(mode && mode !== b.dataset.mode &&
       !confirm('Trocar opera√ß√£o limpa os dados atuais. Continuar?')) return;

    mode = b.dataset.mode;
    buttons.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');

    eventoSelecionado = null;
    vendedorSelecionado = null;
    comissoesPendentes = [];

    render();
  };
});

async function iniciarCentralFinanceira() {
  try {
    // Pr√©-carrega vendedores
    vendedoresCache = await Auth.apiCall('listarVendedores') || [];
    console.log('‚úÖ Vendedores carregados:', vendedoresCache.length);
  } catch (err) {
    console.error('Erro ao iniciar Central Financeira:', err);
    alert('Erro ao carregar dados iniciais');
  }
}

/* ================= RENDER ================= */

function render(){
  if(mode === 'recebimento') renderRecebimento();
  if(mode === 'estorno') renderEstorno();
  if(mode === 'comissao') renderComissao();
  if(mode === 'obrigacao') renderObrigacao();
}
function renderEstorno(){
  resumo.innerHTML = '<span class="muted">Selecione um evento para estornar um recebimento</span>';

  form.innerHTML = `
    <h3>üî¥ Estorno de Recebimento</h3>

    <label>Evento (Contratante)</label>
    <input id="inputEvento" onkeyup="buscarEvento(this.value)">
    <div id="evSug" class="autocomplete"></div>

    <div class="divider"></div>

    <div id="listaRecebimentos" class="muted">
      Selecione um evento para listar os recebimentos
    </div>

    <div class="divider"></div>

    <div id="formEstorno" style="display:none">
      <label>ID do Recebimento</label>
      <input id="idRecebimento" readonly>

      <label>Valor original recebido</label>
      <input id="valorOriginal" readonly>

      <label>Valor do estorno</label>
      <input type="number" id="valorEstorno">

      <label>Motivo do estorno</label>
      <select id="motivoEstorno">
        <option value="">Selecione o motivo</option>
        <option value="CANCELAMENTO_EVENTO">Cancelamento do evento</option>
        <option value="ERRO_LANCAMENTO">Erro de lan√ßamento</option>
        <option value="DEVOLUCAO_VALOR">Devolu√ß√£o de valor</option>
        <option value="OUTROS">Outros</option>
      </select>

      <button class="btn danger" onclick="submitEstorno()">üî¥ Confirmar Estorno</button>
    </div>
  `;
}
function submitEstorno(){
  const btn = event?.target;
  if (lockSubmit) return;

  const idRecebimento = document.getElementById('idRecebimento').value.trim();
  const valor = parseValorSeguro(document.getElementById('valorEstorno').value);
  const motivo = document.getElementById('motivoEstorno').value;

  if (!idRecebimento) return alert('Informe o ID do recebimento');
  if (!valor) return alert('Informe um valor de estorno v√°lido');

  if (!confirm('Deseja realmente estornar este recebimento?')) return;

  lockSubmit = true;
  bloquearBotao(btn);
  showLoading('Registrando estorno...');

  const payload = {
    idRecebimento: idRecebimento,
    valor: valor,
    motivo: motivo
  };

  Auth.apiCall('apiEstornarRecebimento', payload)
  .then(resp => {
    hideLoading();
    lockSubmit = false;
    liberarBotao(btn);

    if (!resp || resp.sucesso !== true) {
      alert(resp?.mensagem || 'Erro ao registrar estorno');
      return;
    }

    resumo.innerHTML = '<span class="muted">Estorno registrado com sucesso</span>';
    alert('Estorno realizado com sucesso');
  })
  .catch(err => {
    hideLoading();
    lockSubmit = false;
    liberarBotao(btn);
    tratarErroApi(err);
  });
}

/* ================= RECEBIMENTO ================= */

function renderRecebimento(){
  resumo.innerHTML = '<span class="muted">Selecione um evento</span>';

  form.innerHTML = `
    <h3>Recebimento</h3>

    <label>Evento (Contratante)</label>
    <input id="inputEvento" onkeyup="buscarEvento(this.value)">
    <div id="evSug" class="autocomplete"></div>

    <label>Valor</label>
    <input type="number" id="valor" oninput="avaliarValorRecebimento(this.value)">

    <label>Data do Registro</label>
    <input type="date" id="data" readonly value="${hojeLocalISO()}">

    <label>Forma de Pagamento</label>
    <select id="forma">
      <option>PIX</option>
      <option>TED</option>
      <option>Dinheiro</option>
    </select>

    <label>Link do Comprovante</label>
    <input id="comprovante">
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="file" id="fileComprovanteRecebimento" accept="image/png,image/jpeg,application/pdf">
      <button type="button" class="btn secondary"
        onclick="uploadComprovanteParaCampo('fileComprovanteRecebimento','comprovante','RECEBIMENTO', eventoSelecionado || '')">
        üìé Carregar Comprovante
      </button>
    </div>

    <label>Observa√ß√µes</label>
    <textarea id="obs"></textarea>

    <button class="btn primary" onclick="submitRecebimento()">Registrar Recebimento</button>
  `;
}

/* ================= COMISSAO ================= */

async function garantirVendedoresCarregados(callback){
  if (Array.isArray(vendedoresCache) && vendedoresCache.length > 0) {
    callback();
    return;
  }

  try {
    vendedoresCache = await Auth.apiCall('listarVendedores') || [];
    callback();
  } catch (err) {
    console.error('Erro ao carregar vendedores:', err);
    alert('Erro ao carregar vendedores');
  }
}

function renderComissao(){
  resumo.innerHTML = '<span class="muted">Selecione um vendedor</span>';

  form.innerHTML = `
    <h3>Comiss√£o</h3>

    <label>Vendedor</label>
    <select id="selectVendedor"></select>

    <div class="divider"></div>

    <h4>Fechamento de Comiss√£o (V2)</h4>
    <p class="muted">
      Este processo paga <strong>100% das comiss√µes pendentes</strong> do vendedor selecionado,
      independentemente de data ou per√≠odo.
    </p>

    <div class="divider"></div>
    <p class="muted">
      ‚ö†Ô∏è Aten√ß√£o: esta a√ß√£o √© irrevers√≠vel. Todas as comiss√µes pendentes ser√£o marcadas como pagas
      e o valor ser√° acumulado em <strong>VALOR_COMISSAO_PAGO</strong> nos eventos.
    </p>

    <label>Ajuste Cr√©dito</label>
    <input type="number" id="ajCredito" value="0">

    <label>Ajuste D√©bito</label>
    <input type="number" id="ajDebito" value="0">

    <label>Link Comprovante Pagamento</label>
    <input id="linkPagamento">
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="file" id="fileComprovanteFechamento" accept="image/png,image/jpeg,application/pdf">
      <button type="button" class="btn secondary"
        onclick="uploadComprovanteParaCampo('fileComprovanteFechamento','linkPagamento','FECHAMENTO_COMISSAO', vendedorSelecionado?.id || '')">
        üìé Carregar Comprovante
      </button>
    </div>

    <label style="margin-top:16px">
      <input type="checkbox" id="confirmarFechamento">
      Confirmo que revisei os valores e desejo gerar o fechamento.
    </label>

    <button class="btn secondary" onclick="executarFechamentoV2()">
      üîí Executar Fechamento
    </button>
  `;

  garantirVendedoresCarregados(()=>{
    const sel = document.getElementById('selectVendedor');
    if (!sel) return;
    sel.innerHTML = '<option value="">Selecione...</option>';
    vendedoresCache.forEach(v=>{
      const o = document.createElement('option');
      o.value = v.id;
      o.textContent = v.id + ' ‚Äî ' + v.nome;
      sel.appendChild(o);
    });
    sel.onchange = ()=>{
      vendedorSelecionado = vendedoresCache.find(v=>v.id==sel.value);
      if (vendedorSelecionado) carregarResumoVendedor();
    };
  });
}

/* ================= OBRIGACAO ================= */

function renderObrigacao(){
  resumo.innerHTML = '<span class="muted">Selecione um evento</span>';

  form.innerHTML = `
<h3>üü† Sa√≠das do Evento</h3>

<label>Evento (Contratante)</label>
<input id="inputEvento" onkeyup="buscarEvento(this.value)">
<div id="evSug" class="autocomplete"></div>

<div class="divider"></div>

<label>Tipo de sa√≠da</label>
<select id="tipoSaida" onchange="renderCamposSaida()">
  <option value="">Selecione...</option>
  <option value="BV_EVENTO">B√¥nus de Venda (BV)</option>
  <option value="FOLHA_EVENTO">Folha / Custos do Evento</option>
</select>
<div class="muted" style="margin-top:12px">
  üìÑ <strong>Nota Fiscal (NF)</strong><br>
  Quando configurada no cadastro do evento, a NF √© considerada
  <strong>processada automaticamente</strong> e n√£o requer a√ß√£o manual nesta tela.
</div>

<div id="camposSaida"></div>
`;
}

function renderCamposSaida() {
  const box = document.getElementById('camposSaida');
  const tipo = document.getElementById('tipoSaida').value;
  if (!box) return;

  if (!tipo) {
    box.innerHTML = '';
    return;
  }

  if (tipo === 'BV_EVENTO') {
    box.innerHTML = `
      <label>Valor</label>
      <input type="number" id="valorSaida" readonly>

      <label>Data</label>
      <input type="date" id="dataSaida" value="${hojeLocalISO()}">

      <label>Link do Comprovante</label>
      <input id="comprovanteSaida">
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input type="file" id="fileComprovanteSaida" accept="image/png,image/jpeg,application/pdf">
        <button type="button" class="btn secondary"
          onclick="uploadComprovanteParaCampo('fileComprovanteSaida','comprovanteSaida','SAIDA_EVENTO', eventoSelecionado || '')">
          üìé Carregar Comprovante
        </button>
      </div>

      <label>Observa√ß√µes</label>
      <textarea id="obsSaida"></textarea>

      <button class="btn primary" onclick="submitSaidaEvento()">Registrar Sa√≠da</button>

      <div class="muted" style="margin-top:8px">
        ‚ÑπÔ∏è O valor desta sa√≠da √© definido automaticamente pelo cadastro do evento.
      </div>
    `;
  }

  if (tipo === 'FOLHA_EVENTO') {
    box.innerHTML = `
      <label>Valor da folha</label>
      <input type="number" id="valorSaida">

      <label>Descri√ß√£o detalhada</label>
      <textarea id="obsSaida" placeholder="Ex: Banda, som, transporte, alimenta√ß√£o..."></textarea>

      <button class="btn primary" onclick="submitSaidaEvento()">Registrar Folha</button>

      <div class="muted" style="margin-top:8px">
        ‚ÑπÔ∏è Este valor ser√° somado aos custos totais do evento.
      </div>
    `;
  }
}

function submitSaidaEvento() {
  const btn = event?.target;
  if (lockSubmit) return;
  if (!eventoSelecionado) return alert('Selecione um evento');

  const tipo = document.getElementById('tipoSaida').value;
  if (!tipo) return alert('Selecione o tipo de sa√≠da');

  let valor = 0;
  let observacoes = '';
  let comprovante = '';

  if (tipo === 'NF_EVENTO' || tipo === 'BV_EVENTO') {
    valor = parseValorSeguro(document.getElementById('valorSaida').value);
    comprovante = document.getElementById('comprovanteSaida')?.value || '';
    observacoes = document.getElementById('obsSaida')?.value || '';
    if (!valor) return alert('Valor inv√°lido');
  }

  if (tipo === 'FOLHA_EVENTO') {
    valor = parseValorSeguro(document.getElementById('valorSaida').value);
    observacoes = document.getElementById('obsSaida')?.value || '';
    if (!valor) return alert('Informe o valor da folha');
    if (!observacoes) return alert('Descreva os custos da folha');
  }

  if (!confirm('Confirmar registro desta sa√≠da?')) return;

  lockSubmit = true;
  bloquearBotao(btn);
  showLoading('Registrando sa√≠da...');

  const payload = {
    tipoOperacao: 'SAIDA_EVENTO',
    tipoSaida: tipo,
    idEvento: eventoSelecionado,
    valor: valor,
    observacoes: observacoes,
    linkComprovante: comprovante
  };

  Auth.apiCall('apiRegistrarSaidaEvento', payload)
  .then(resp => {
    hideLoading();
    lockSubmit = false;
    liberarBotao(btn);

    if (!resp || resp.sucesso !== true) {
      alert(resp?.mensagem || 'Erro ao registrar sa√≠da');
      return;
    }

    alert('Sa√≠da registrada com sucesso');
    resetObrigacaoForm();
  })
  .catch(err => {
    hideLoading();
    lockSubmit = false;
    liberarBotao(btn);
    tratarErroApi(err);
  });
}

/* ================= AUTOCOMPLETE EVENTO ================= */

async function buscarEvento(q){
  if (!q || q.length < 2) return;

  const box = document.getElementById('evSug');
  if (!box) return;

  try {
    const list = await Auth.apiCall('buscarEventoPorContratante', {
      nome: q
    });

    box.innerHTML = '';

    (list || []).forEach(ev => {
      const d = document.createElement('div');
      d.textContent = ev.id + ' ‚Äî ' + ev.contratante;
      d.onclick = () => selectEvento(ev);
      box.appendChild(d);
    });

  } catch (err) {
    console.error('Erro ao buscar evento:', err);
    box.innerHTML = '';
  }
}

async function selectEvento(ev){
  const inp = document.getElementById('inputEvento');
  if (inp) inp.value = ev.id + ' ‚Äî ' + ev.contratante;
  const idEventoReal = ev.id || ev.ID_EVENTO;
  eventoSelecionado = idEventoReal;
  document.getElementById('evSug').innerHTML = '';

  resumo.innerHTML = '<span class="muted">Carregando resumo financeiro...</span>';

  try {
  const fin = await Auth.apiCall('buscarResumoFinanceiroEvento', {
    idEvento: idEventoReal
  });

  ultimoResumoFinanceiro = fin;

  if (!fin) {
    resumo.innerHTML = '<span class="muted">Resumo financeiro indispon√≠vel</span>';
    return;
  }

  const vt = Number(fin.valorTotal) || 0;
  let vr = Number(fin.valorRecebido);
  let vp = Number(fin.valorPendente);

  if (isNaN(vr)) {
    vr = vt - (isNaN(vp) ? 0 : vp);
  }

  if (isNaN(vp)) {
    vp = vt - (isNaN(vr) ? 0 : vr);
  }

  let extraHtml = '';
  let statusFinal = fin.statusRecebimento || '‚Äî';

  if (vp < 0) {
    const excedente = Math.abs(vp);
    extraHtml = `
      <div style="margin-top:6px;color:#facc15">
        ‚ö†Ô∏è Valor pago a mais: R$ ${excedente.toFixed(2)}
      </div>
    `;
    statusFinal = 'QUITADO (com excedente)';
  }

  resumo.innerHTML = `
    <div><strong>Evento:</strong> ${ev.tipoEvento}</div>
    <div><strong>Contratante:</strong> ${ev.contratante}</div>
    <div class="divider"></div>
    <div><strong>Valor total do evento:</strong> R$ ${vt.toFixed(2)}</div>
    <div><strong>Valor recebido at√© agora:</strong> R$ ${vr.toFixed(2)}</div>
    <div><strong>Valor pendente atual:</strong> R$ ${vp.toFixed(2)}</div>
    ${extraHtml}
    <div><strong>Status:</strong> ${statusFinal}</div>
  `;

  if (mode === 'estorno') {
    listarRecebimentosEvento(idEventoReal);
  }

} catch (err) {
  console.error('Erro ao carregar resumo financeiro:', err);
  resumo.innerHTML = '<span class="muted">Erro ao carregar resumo financeiro</span>';
}
}

async function listarRecebimentosEvento(idEvento){
  const box = document.getElementById('listaRecebimentos');
  box.innerHTML = '<span class="muted">Carregando recebimentos...</span>';

  try {
  const list = await Auth.apiCall('listarRecebimentosPorEvento', {
    idEvento: idEvento
  });

  if (!Array.isArray(list) || list.length === 0) {
    box.innerHTML = '<span class="muted">‚ÑπÔ∏è Este evento ainda n√£o possui recebimentos registrados. Caso tenha sido pago fora do sistema, registre primeiro o recebimento.</span>';
    return;
  }

  box.innerHTML = '<strong>Recebimentos do evento:</strong>';

  list.forEach(r=>{
    const div = document.createElement('div');
    div.style.marginTop = '8px';
    div.style.padding = '8px';
    div.style.borderRadius = '8px';
    div.style.background = '#0f172a';
    div.style.cursor = 'pointer';

    div.innerHTML = `
      <div>${r.dataFormatada} ‚Ä¢ ${r.formaPagamento || '‚Äî'} ‚Ä¢ <strong>R$ ${Number(r.valor).toFixed(2)}</strong></div>
      <div class="muted">ID: ${r.id}</div>
    `;

    div.onclick = () => selecionarRecebimentoParaEstorno(r);

    box.appendChild(div);
  });

} catch (err) {
  console.error('Erro ao listar recebimentos:', err);
  box.innerHTML = '<span class="muted">Erro ao carregar recebimentos</span>';
}
}

function selecionarRecebimentoParaEstorno(r){
  const receb = typeof r === 'string' ? JSON.parse(decodeURIComponent(r)) : r;

  document.getElementById('formEstorno').style.display = 'block';
  const formEl = document.getElementById('formEstorno');
  if (formEl && typeof formEl.scrollIntoView === 'function') {
    formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  document.getElementById('idRecebimento').value = receb.id;
  document.getElementById('valorOriginal').value = Number(receb.valor).toFixed(2);
  document.getElementById('valorEstorno').value = Number(receb.valor).toFixed(2);

  resumo.innerHTML = `
    <div><strong>Evento:</strong> ${receb.nomeEvento}</div>
    <div><strong>Recebimento selecionado:</strong> ${receb.id}</div>
    <div><strong>Valor original:</strong> R$ ${Number(receb.valor).toFixed(2)}</div>
    <div><strong>Data:</strong> ${receb.dataFormatada}</div>
  `;
}

/* ================= AUTOCOMPLETE VENDEDOR ================= */

function buscarVendedor(q){
  if(q.length < 2) return;
  const box = document.getElementById('venSug');
  box.innerHTML = '';
  vendedoresCache
    .filter(v=>v.nome.toLowerCase().includes(q.toLowerCase()))
    .slice(0,10)
    .forEach(v=>{
      const d = document.createElement('div');
      d.textContent = v.id + ' ‚Äî ' + v.nome;
      d.onclick = ()=>{
        vendedorSelecionado = v;
        box.innerHTML = '';
        carregarResumoVendedor();
      };
      box.appendChild(d);
    });
}

function carregarResumoVendedor(){
  resumo.innerHTML = '<span class="muted">Carregando resumo do fechamento...</span>';

  Auth.apiCall('visualizarPreviewFechamento', {
    idVendedor: vendedorSelecionado.id
  })
  .then(preview => {
    ultimoPreview = preview;

    // ================= NOVA REGRA DE FILTRO DO PREVIEW DE FECHAMENTO =================
    // Exibe:
    // 1) Comiss√µes com STATUS === 'PENDENTE'
    // 2) Comiss√µes j√° inclu√≠das em fechamento do tipo COMISSAO_GERADA que tenham estorno de recebimento posterior sem ajuste de comiss√£o resolvido
    //    (marcando ajusteNecessario: true, ajusteComissao: valorNegativoCalculado)
    // 3) N√ÉO exibe comiss√µes j√° ajustadas (ou seja, se j√° existe movimenta√ß√£o AJUSTE_COMISSAO_ESTORNO PROCESSADA para aquela comiss√£o)
    if (Array.isArray(preview.eventos)) {
      // Para facilitar, indexa movimenta√ß√µes por tipo e refer√™ncia
      const movsPorTipo = {};
      if (Array.isArray(preview.movimentacoes)) {
        preview.movimentacoes.forEach(mov => {
          if (!movsPorTipo[mov.tipo]) movsPorTipo[mov.tipo] = [];
          movsPorTipo[mov.tipo].push(mov);
        });
      }
      // Helper para encontrar estorno de recebimento relacionado a uma comiss√£o
      function encontrarEstornosParaComissao(ev) {
        // Suporta Ref: MOV-XXXX em ev.referenciaMovimentacao ou campo similar
        const ref = (ev.referenciaMovimentacao || ev.referencia || ev.refMovimentacao || ev.idMovimentacao || ev.idMovRecebimento || '').toString();
        if (!ref) return [];
        // Procurar estornos de recebimento relacionados ao mesmo MOV-XXXX
        const estornos = (movsPorTipo['ESTORNO_RECEBIMENTO'] || []).filter(mov => {
          // Checa se referenciaMovimentacao ou descricao cont√©m o id da movimenta√ß√£o original
          // O padr√£o √© "Ref: MOV-XXXX"
          if (mov.referenciaMovimentacao && mov.referenciaMovimentacao === ref) return true;
          if (mov.descricao && ref && mov.descricao.includes(ref)) return true;
          if (ref && mov.referencia && mov.referencia === ref) return true;
          // Tamb√©m aceita se o n√∫mero do MOV-XXXX est√° no campo descri√ß√£o
          if (ref && mov.descricao && ref.replace('MOV-', '') && mov.descricao.includes(ref.replace('MOV-', ''))) return true;
          return false;
        });
        return estornos;
      }
      // Helper para saber se j√° existe ajuste de comiss√£o estorno processado para essa comiss√£o
      function existeAjusteComissaoEstorno(ev) {
        // Procura movimenta√ß√£o do tipo AJUSTE_COMISSAO_ESTORNO ligada a este ev (pelo id da comiss√£o ou referencia)
        const ref = (ev.referenciaMovimentacao || ev.referencia || ev.refMovimentacao || ev.idMovimentacao || ev.idMovRecebimento || '').toString();
        return (movsPorTipo['AJUSTE_COMISSAO_ESTORNO'] || []).some(mov => {
          // Considera resolvido se estiver processado e ligado √† mesma refer√™ncia
          const statusOk = (mov.status === 'PROCESSADO' || mov.status === 'FINALIZADO' || !mov.status); // fallback: sem status = processado
          if (!statusOk) return false;
          if (mov.referenciaMovimentacao && mov.referenciaMovimentacao === ref) return true;
          if (mov.descricao && ref && mov.descricao.includes(ref)) return true;
          if (ref && mov.referencia && mov.referencia === ref) return true;
          if (ref && mov.descricao && ref.replace('MOV-', '') && mov.descricao.includes(ref.replace('MOV-', ''))) return true;
          return false;
        });
      }
      // Helper para calcular ajuste de comiss√£o proporcional ao estorno
      function calcularAjusteComissao(ev, estornoMov) {
        // Propor√ß√£o: valor do estorno / valor do recebimento original * valor da comiss√£o original
        const valorRecebido = Number(ev.valorRecebido || 0);
        const valorComissao = Number(ev.valorComissao || 0);
        const valorEstornado = Number(estornoMov.valor || 0);
        if (!valorRecebido || !valorComissao || !valorEstornado) return 0;
        // Calcula proporcional negativo
        const prop = valorEstornado / valorRecebido;
        const ajuste = -1 * Math.abs(Number((valorComissao * prop).toFixed(2)));
        return ajuste;
      }
      // Aplica o filtro final
      preview.eventos = preview.eventos
        .map(ev => {
          // 1. STATUS PENDENTE: sempre inclui
          if (ev.statusComissao === 'PENDENTE') return ev;
          // 2. Comiss√µes j√° fechadas do tipo COMISSAO_GERADA:
          if (
            ev.tipoComissao === 'COMISSAO_GERADA' &&
            ev.statusComissao !== 'PENDENTE' &&
            (ev.incluidoEmFechamento || ev.incluido_em_fechamento || ev.INCLUIDO_EM_FECHAMENTO)
          ) {
            // S√≥ inclui se houver estorno posterior relacionado e N√ÉO houver ajuste j√° processado
            if (existeAjusteComissaoEstorno(ev)) return null; // j√° ajustada, n√£o exibe
            const estornos = encontrarEstornosParaComissao(ev);
            if (estornos.length > 0) {
              // Soma todos os ajustes necess√°rios (caso haja m√∫ltiplos estornos)
              const ajusteTotal = estornos.reduce((soma, est) => soma + calcularAjusteComissao(ev, est), 0);
              if (ajusteTotal !== 0) {
                // Retorna um novo objeto com ajusteNecessario, ajusteComissao
                return {
                  ...ev,
                  ajusteNecessario: true,
                  ajusteComissao: ajusteTotal
                };
              }
            }
            // Se n√£o h√° estorno n√£o ajustado, n√£o exibe
            return null;
          }
          // 3. Para outros casos, descarta (ex: j√° inclu√≠da em fechamento e sem ajuste pendente)
          return null;
        })
        .filter(ev => !!ev);

      // Recalcula totais ap√≥s filtro
      preview.totalEventos = preview.eventos.length;
      preview.totalComissao = preview.eventos.reduce(
        (s, e) => s + (Number(e.valorComissao || 0) + Number(e.ajusteComissao || 0)),
        0
      );
    }

    // 1Ô∏è‚É£ Preview n√£o retornou nada (erro silencioso no backend)
    if (!preview) {
      resumo.innerHTML = `
        <div><strong>Vendedor:</strong> ${vendedorSelecionado.nome}</div>
        <div class="muted">Erro ao gerar resumo (resposta vazia)</div>
      `;
      return;
    }

    // 2Ô∏è‚É£ Backend retornou erro expl√≠cito
    if (preview.sucesso === false) {
      resumo.innerHTML = `
        <div><strong>Vendedor:</strong> ${vendedorSelecionado.nome}</div>
        <div class="muted">Erro ao gerar resumo: ${preview.mensagem}</div>
      `;
      return;
    }

    // 3Ô∏è‚É£ Nenhuma comiss√£o pendente (mas pode haver ajuste por estorno)
    if (!Array.isArray(preview.eventos) || preview.eventos.length === 0) {
      const existeAjuste =
        preview.existeAjustePendentes === true ||
        (Array.isArray(preview.ajustesPendentes) && preview.ajustesPendentes.length > 0) ||
        (typeof preview.totalAjuste === 'number' && preview.totalAjuste !== 0);

      let alertaAjusteHtml = '';
      if (existeAjuste) {
        alertaAjusteHtml = `
  <div style="
    margin-top:12px;
    padding:12px;
    border-radius:10px;
    background:#7c2d12;
    color:#fed7aa;
    font-size:13px;
  ">
    ‚ö†Ô∏è <strong>Ajuste de comiss√£o por estorno</strong><br><br>

    Estorno realizado ao cliente: 
    <strong>R$ ${Number(preview.totalEstornoCliente || 0).toFixed(2)}</strong><br>

    Impacto na comiss√£o: 
    <strong>-R$ ${Math.abs(Number(preview.totalAjuste || 0)).toFixed(2)}</strong><br><br>

    Este valor ser√° descontado <strong>neste fechamento</strong> para compensar
    uma comiss√£o que j√° havia sido paga integralmente.
  </div>
`;
      }

      resumo.innerHTML = `
        <div><strong>Vendedor:</strong> ${vendedorSelecionado.nome}</div>
        ${alertaAjusteHtml}
        <div class="muted">
          Nenhuma comiss√£o nova pendente, por√©m o fechamento possui ajustes a serem aplicados.
        </div>
      `;
      return;
    }

    // üîî ALERTA VISUAL ‚Äî AJUSTE DE COMISS√ÉO PENDENTE
    const existeAjuste =
      preview.existeAjustePendentes === true ||
      (Array.isArray(preview.ajustesPendentes) && preview.ajustesPendentes.length > 0) ||
      (typeof preview.totalAjuste === 'number' && preview.totalAjuste !== 0);

    let alertaAjusteHtml = '';
    if (existeAjuste) {
      alertaAjusteHtml = `
  <div style="
    margin-top:12px;
    padding:12px;
    border-radius:10px;
    background:#7c2d12;
    color:#fed7aa;
    font-size:13px;
  ">
    ‚ö†Ô∏è <strong>Ajuste de comiss√£o por estorno</strong><br><br>

    Estorno realizado ao cliente: 
    <strong>R$ ${Number(preview.totalEstornoCliente || 0).toFixed(2)}</strong><br>

    D√©bito de comiss√£o correspondente: 
    <strong>-R$ ${Math.abs(Number(preview.totalAjuste || 0)).toFixed(2)}</strong><br><br>

    Este valor ser√° descontado <strong>neste fechamento</strong> para compensar
    uma comiss√£o que j√° havia sido paga integralmente.
  </div>
`;
    }

    // 4Ô∏è‚É£ Render normal
    const totalFinal = Number(preview.totalComissao || 0) + Number(preview.totalAjuste || 0);
    let html = `
      <div><strong>Vendedor:</strong> ${vendedorSelecionado.nome}</div>
      ${alertaAjusteHtml}
      <div><strong>Eventos no fechamento:</strong> ${preview.totalEventos}</div>
      <div><strong>Total de comiss√£o a pagar:</strong> R$ ${totalFinal.toFixed(2)}</div>
      <div class="divider"></div>
      <div><strong>Detalhamento das Comiss√µes (origem):</strong></div>
    `;
    if (preview.existeExcecao) {
      html += `
        <div style="margin-top:12px;padding:10px;border-radius:8px;
                    background:#7c2d12;color:#fed7aa;font-size:13px">
          ‚ö†Ô∏è Aten√ß√£o: uma ou mais comiss√µes n√£o puderam ter a origem do
          recebimento validada automaticamente.<br>
          Revise antes de confirmar o fechamento.
        </div>
      `;
    }

    preview.eventos.forEach(ev => {
      const ajuste = Number(ev.ajusteComissao || 0);
      const temAjuste = ajuste !== 0;

      html += `
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid #1e293b">
          <div><strong>${ev.nomeEvento}</strong></div>
          <div class="muted">
            ‚Ä¢ Recebimento registrado em: ${ev.dataRecebimento || '‚Äî'}
          </div>
          <div class="muted">
            ‚Ä¢ Valor recebido: R$ ${Number(ev.valorRecebido || 0).toFixed(2)}
          </div>
          <div>
            Comiss√£o pendente: <strong>R$ ${Number(ev.valorComissao || 0).toFixed(2)}</strong>
          </div>
          ${Number(ev.ajusteComissao || 0) !== 0 ? `
            <div style="margin-top:6px;color:#facc15;font-size:13px">
              ‚ö†Ô∏è Ajuste por estorno aplicado nesta comiss√£o (-R$ ${Math.abs(ev.ajusteComissao).toFixed(2)})
            </div>
          ` : ``}
        </div>
      `;
    });

    html += `
      <div class="divider"></div>
      <div class="muted">
        ‚ö†Ô∏è Confirme os valores acima. Ap√≥s o fechamento, as comiss√µes ser√£o marcadas como PAGAS e n√£o poder√£o ser revertidas.
      </div>
    `;

    resumo.innerHTML = html;
  })
  .catch(err => {
    console.error('Erro ao gerar preview de comiss√£o:', err);
    resumo.innerHTML = `
      <div><strong>Vendedor:</strong> ${vendedorSelecionado?.nome || '‚Äî'}</div>
      <div class="muted">Erro ao gerar resumo do fechamento</div>
    `;
  });
}

/* ================= VALIDACOES & UTIL ================= */

let lockSubmit = false;

async function uploadComprovanteParaCampo(fileInputId, targetInputId, categoria, referencia) {
  const input = document.getElementById(fileInputId);
  const target = document.getElementById(targetInputId);
  if (!input || !target) return alert('Campo de comprovante n√£o encontrado.');

  const file = input.files && input.files[0];
  if (!file) return alert('Selecione um arquivo de comprovante.');

  const mimeType = (file.type || inferirMimePorNomeArquivo(file.name) || '').toLowerCase();
  const tiposPermitidos = ['image/png', 'image/jpeg', 'application/pdf'];
  if (!tiposPermitidos.includes(mimeType)) {
    return alert('Formato inv√°lido. Use PNG, JPG ou PDF.');
  }

  const maxBytes = 2 * 1024 * 1024;
  if (file.size > maxBytes) {
    return alert('Arquivo maior que 2MB. Reduza o comprovante e tente novamente.');
  }

  const btn = event?.target;
  bloquearBotao(btn);
  showLoading('Enviando comprovante...');

  try {
    const dataUrl = await lerArquivoComoDataURL(file);
    const base64 = (dataUrl.split(',')[1] || '').trim();
    if (!base64) throw new Error('Falha ao ler arquivo selecionado');

    const resp = await Auth.apiCall('apiUploadComprovante', {
      arquivoBase64: base64,
      mimeType: mimeType,
      nomeArquivo: file.name,
      categoria: categoria || 'GERAL',
      referencia: referencia || ''
    });

    if (!resp || resp.sucesso !== true || !resp.linkArquivo) {
      throw new Error(resp?.mensagem || 'Falha no upload do comprovante');
    }

    target.value = resp.linkArquivo;
    input.value = '';
    alert('Comprovante carregado com sucesso.');
  } catch (err) {
    tratarErroApi(err);
  } finally {
    hideLoading();
    liberarBotao(btn);
  }
}

function lerArquivoComoDataURL(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result || '');
    reader.onerror = () => reject(new Error('N√£o foi poss√≠vel ler o arquivo.'));
    reader.readAsDataURL(file);
  });
}

function inferirMimePorNomeArquivo(nome) {
  const n = String(nome || '').toLowerCase();
  if (n.endsWith('.png')) return 'image/png';
  if (n.endsWith('.jpg') || n.endsWith('.jpeg')) return 'image/jpeg';
  if (n.endsWith('.pdf')) return 'application/pdf';
  return '';
}

function tratarErroApi(err) {
  console.error('Erro API:', err);

  if (!err) {
    alert('Erro inesperado.');
    return;
  }

  if (err.mensagem) {
    alert(err.mensagem);
    return;
  }

  if (err.error) {
    alert(err.error);
    return;
  }

  if (typeof err === 'string') {
    alert(err);
    return;
  }

  alert('Erro ao processar a opera√ß√£o.');
}

function hojeLocalISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function parseValorSeguro(raw) {
  if (raw === null || raw === undefined) return null;

  // If already a number, validate directly
  if (typeof raw === 'number') {
    return raw > 0 ? raw : null;
  }

  if (typeof raw !== 'string') return null;

  let v = raw.trim();

  if (!v) return null;

  // Remove spaces
  v = v.replace(/\s/g, '');

  // If format contains both "." and ","
  // Assume "." is thousand separator and "," is decimal
  if (v.includes('.') && v.includes(',')) {
    v = v.replace(/\./g, '').replace(',', '.');
  }
  // If only comma, treat as decimal separator
  else if (v.includes(',')) {
    v = v.replace(',', '.');
  }
  // If only dot, keep as decimal separator (do nothing)

  const n = Number(v);

  if (isNaN(n) || n <= 0) return null;

  // Force two decimal precision (currency safety)
  return Number(n.toFixed(2));
}

function avaliarValorRecebimento(valorDigitado){
  const v = Number(valorDigitado);
  if (isNaN(v) || !ultimoResumoFinanceiro) return;

  let aviso = '';

  if (v > ultimoResumoFinanceiro.valorTotal) {
    aviso = '‚ö†Ô∏è O valor informado ultrapassa o valor TOTAL do evento.';
  } else if (v > ultimoResumoFinanceiro.valorPendente) {
    aviso = '‚ö†Ô∏è O valor informado ultrapassa o valor PENDENTE atual do evento.';
  }

  const avisoId = 'avisoValorRecebimento';
  let box = document.getElementById(avisoId);

  if (aviso) {
    if (!box) {
      box = document.createElement('div');
      box.id = avisoId;
      box.style.marginTop = '8px';
      box.style.fontSize = '13px';
      box.style.color = '#facc15';
      document.getElementById('valor').after(box);
    }
    box.innerText = aviso;
  } else if (box) {
    box.remove();
  }
}

function bloquearBotao(btn) {
  if (!btn) return;
  btn.disabled = true;
  btn.style.opacity = '0.6';
  btn.style.cursor = 'not-allowed';
}

function liberarBotao(btn) {
  if (!btn) return;
  btn.disabled = false;
  btn.style.opacity = '1';
  btn.style.cursor = 'pointer';
}

function resetRecebimentoForm() {
  eventoSelecionado = null;
  document.getElementById('valor').value = '';
  document.getElementById('obs').value = '';
  document.getElementById('comprovante').value = '';
  document.getElementById('evSug').innerHTML = '';
  resumo.innerHTML = '<span class="muted">Selecione um evento</span>';
}

function resetObrigacaoForm() {
  eventoSelecionado = null;

  const inp = document.getElementById('inputEvento');
  if (inp) inp.value = '';

  const tipo = document.getElementById('tipoSaida');
  if (tipo) tipo.value = '';

  const campos = document.getElementById('camposSaida');
  if (campos) campos.innerHTML = '';

  const sug = document.getElementById('evSug');
  if (sug) sug.innerHTML = '';

  resumo.innerHTML = '<span class="muted">Selecione um evento</span>';
}

function resetFechamentoForm() {
  document.getElementById('ajCredito').value = '0';
  document.getElementById('ajDebito').value = '0';
  document.getElementById('linkPagamento').value = '';
  document.getElementById('confirmarFechamento').checked = false;
  resumo.innerHTML = '<span class="muted">Selecione um vendedor</span>';
}

/* ================= SUBMITS ================= */

function submitRecebimento(){
  const btn = event?.target;
  if (lockSubmit) return;
  if(!eventoSelecionado) return alert('Selecione um evento');

  const valorRaw = document.getElementById('valor').value;
  const valor = parseValorSeguro(valorRaw);
  if (!valor) return alert('Informe um valor v√°lido maior que zero.');

  lockSubmit = true;
  bloquearBotao(btn);
  showLoading('Registrando recebimento...');

  const payload = {
    tipoOperacao:'RECEBIMENTO',
    idEvento:eventoSelecionado,
    valor: valor,
    dataRecebimento:document.getElementById('data').value,
    formaPagamento:document.getElementById('forma').value,
    linkComprovante:document.getElementById('comprovante').value,
    observacoes:document.getElementById('obs').value
  };

  Auth.apiCall('apiRegistrarRecebimento', payload)
  .then(resp => {
    hideLoading();
    lockSubmit = false;
    liberarBotao(btn);

    if (!resp || resp.sucesso !== true) {
      alert(resp?.mensagem || 'Erro ao registrar recebimento');
      return;
    }

    resetRecebimentoForm();
    alert('Recebimento registrado');
  })
  .catch(err => {
    hideLoading();
    lockSubmit = false;
    liberarBotao(btn);
    tratarErroApi(err);
  });
}


/* ================= FECHAMENTO V2 ================= */

function executarFechamentoV2(){
  const btn = event?.target;
  if (lockSubmit) return;
  if(!vendedorSelecionado) return alert('Selecione um vendedor');

  if (!document.getElementById('confirmarFechamento')?.checked) {
    return alert('Voc√™ deve confirmar que revisou os valores antes de fechar.');
  }

  lockSubmit = true;
  bloquearBotao(btn);

  const payload = {
    idVendedor: vendedorSelecionado.id,
    ajusteCredito: parseValorSeguro(document.getElementById('ajCredito').value) || 0,
    ajusteDebito: parseValorSeguro(document.getElementById('ajDebito').value) || 0,
    linkComprovante: document.getElementById('linkPagamento').value
  };

  if(!confirm(
    'Voc√™ est√° prestes a PAGAR TODAS as comiss√µes pendentes deste vendedor.\\n' +
    'Esta a√ß√£o n√£o pode ser desfeita.'
  )) {
    lockSubmit = false;
    liberarBotao(btn);
    return;
  }

  showLoading('Gerando fechamento e PDF...');

  Auth.apiCall('fecharComissaoVendedor', {
    idVendedor: payload.idVendedor,
    ajusteCredito: payload.ajusteCredito,
    ajusteDebito: payload.ajusteDebito,
    linkComprovante: payload.linkComprovante
  })
  .then(resp => {
    hideLoading();
    lockSubmit = false;
    liberarBotao(btn);

    if (!resp || resp.sucesso !== true) {
      alert(resp?.mensagem || 'Erro ao fechar comiss√£o');
      return;
    }

    resetFechamentoForm();
    alert(resp.mensagem || 'Fechamento realizado com sucesso');
    if (resp.linkPdf) window.open(resp.linkPdf, '_blank');
  })
  .catch(err => {
    hideLoading();
    lockSubmit = false;
    liberarBotao(btn);
    tratarErroApi(err);
  });
}
</script>

</div>
<div id="loading" class="loading-overlay">
  <div class="loading-spinner"></div>
  <div id="loadingText">Processando...</div>
</div>

  <!-- Bottom Navigation ‚Äî Padr√£o Global -->
  <nav class="bottom-nav">
    <button class="bnav-item" onclick="window.location.href='index.html'">
      <i data-lucide="layout-grid"></i>
      <span>In√≠cio</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='agenda.html'">
      <i data-lucide="calendar-days"></i>
      <span>Agenda</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='cadastro-evento.html'">
      <i data-lucide="plus-circle"></i>
      <span>Novo</span>
    </button>
    <button class="bnav-item" onclick="window.location.href='editar-evento.html'">
      <i data-lucide="pencil-line"></i>
      <span>Editar</span>
    </button>
    <button class="bnav-item active">
      <i data-lucide="dollar-sign"></i>
      <span>Financeiro</span>
    </button>
  </nav>

  <script>
  // Inicializa Lucide icons e header do usu√°rio
  document.addEventListener('DOMContentLoaded', function() {
    if (window.lucide) lucide.createIcons();
    var nome = localStorage.getItem('auth_nome') || '';
    var avatarEl = document.getElementById('ghAvatar');
    var nameEl = document.getElementById('ghName');
    if (avatarEl && nome) {
      var parts = nome.split(' ');
      avatarEl.textContent = parts.length >= 2
        ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase()
        : nome.substring(0,2).toUpperCase();
    }
    if (nameEl) nameEl.textContent = nome.split(' ')[0];
  });
  </script>
</body>
</html>
